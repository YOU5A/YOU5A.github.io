<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP用户管理系统</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://npmcdn.com/dexie/dist/dexie.min.js"></script>

    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        window.alert = function () {
            // 覆盖默认的alert函数，防止浏览器弹窗打扰用户
            console.log('Alert called, but overridden to prevent popup.');
        };
        
        function exportLogsOnly() {
            const data = vipManager.logs || [];
            const filename = `vip-logs-${Date.now()}.json`;
            downloadJSON(data, filename);
        }
        
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#FF7D00',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        info: '#86909C',
                        light: '#F2F3F5',
                        dark: '#1D2129',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .hover-scale {
                transition: transform 0.2s ease-in-out;
            }
            .hover-scale:hover {
                transform: scale(1.02);
            }
            .slide-up {
                animation: slideUp 0.3s ease-out forwards;
            }
            @keyframes slideUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .dark .dark\:bg-dark {
                background-color: #1D2129;
            }
            .dark .dark\:bg-darker {
                background-color: #14171F;
            }
            .dark .dark\:text-light {
                color: #F2F3F5;
            }
            .dark .dark\:border-gray-700 {
                border-color: #2D3239;
            }
            
            /* 暗色主题滚动条 */
            .dark ::-webkit-scrollbar {
                width: 8px;
            }
            .dark ::-webkit-scrollbar-track {
                background: #2D3239;
            }
            .dark ::-webkit-scrollbar-thumb {
                background: #4B5563;
                border-radius: 4px;
            }
            .dark ::-webkit-scrollbar-thumb:hover {
                background: #6B7280;
            }
            
            /* 修复图表显示 */
            #consumptionChart {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            /* 修复设置选择框箭头 */
            .select-arrow {
                pointer-events: none;
                position: absolute;
                right: 0.75rem;
                top: 50%;
                transform: translateY(-50%);
            }
            
            /* 统计模态框高度限制 */
            .stats-container {
                max-height: 80vh;
                overflow-y: auto;
            }
            
            /* 历史记录备注样式 */
            .history-note {
                font-size: 0.75rem;
                color: rgba(107, 114, 128, 0.7);
                margin-top: 2px;
            }
            .dark .history-note {
                color: rgba(156, 163, 175, 0.7);
            }
            
            /* 操作按钮组 */
            .action-buttons {
                opacity: 0;
                pointer-events: none; /* 隐藏时不拦截鼠标 */
                transition: opacity 0.2s ease-in-out;
            }
            .history-item:hover .action-buttons {
                opacity: 1;
                pointer-events: auto; /* 可见时可以点击 */
            }
            
            /* 历史记录项新样式 */
            .history-record {
                font-weight: 500;
            }
            .history-actions {
                display: flex;
                gap: 0.25rem;
            }
        }
    </style>
</head>

<body class="font-inter bg-gray-50 dark:bg-darker min-h-screen flex flex-col overflow-x-hidden">
    <!-- 登录 / Supabase 配置遮罩层 -->
    <div id="authOverlay" class="fixed inset-0 z-[999] bg-black/60 hidden
             items-start justify-start
             overflow-y-auto overscroll-contain
             px-4 py-6
             sm:items-center sm:justify-center sm:overflow-y-hidden sm:px-0 sm:py-0">

            <div class="bg-white dark:bg-dark w-full max-w-lg rounded-2xl shadow-2xl
                        p-4 sm:p-6 mx-auto
                        max-h-[88vh] overflow-y-auto
                        sm:max-h-none sm:overflow-visible">

            <div class="flex items-start justify-between">
                <div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">登录以启用多用户与云端同步</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">离线优先：登录一次后可离线使用（会在恢复网络后同步）。</p>
                </div>
                <button id="authOverlayClose" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors" title="关闭">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>

            <div class="mt-5 space-y-4">
                <div class="p-4 rounded-xl bg-gray-50 dark:bg-gray-800/40 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-gray-900 dark:text-light">Supabase 项目配置</h3>
                        <span id="sbConfigBadge" class="text-xs px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">未配置</span>
                    </div>
                    <label class="block text-xs text-gray-600 dark:text-gray-300 mb-1">Project URL</label>
                    <input id="sbUrlInput" type="text" placeholder="https://xxxxx.supabase.co"
                        class="w-full px-3 py-2 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-primary/40 focus:border-primary outline-none" />

                    <label class="block text-xs text-gray-600 dark:text-gray-300 mt-3 mb-1">Anon Key（publishable）</label>
                    <textarea id="sbAnonInput" rows="3" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                        class="w-full px-3 py-2 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-primary/40 focus:border-primary outline-none"></textarea>

                    
                    <div class="mt-3 space-y-2">
                        <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300 select-none">
                            <input id="autoPullEnabled" type="checkbox" checked
                                class="rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary/50">
                            <span>自动拉取云端更新</span>
                        </label>

                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-600 dark:text-gray-400 w-20">拉取间隔</span>
                            <div class="relative flex-1">
                                <select id="autoPullInterval"
                                    class="w-full pl-3 pr-10 py-2 rounded-lg bg-gray-50 dark:bg-dark/50 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-light focus:ring-2 focus:ring-primary/50 focus:border-primary appearance-none">
                                    <option value="10">10 秒</option>
                                    <option value="30" selected>30 秒</option>
                                    <option value="60">60 秒</option>
                                    <option value="180">3 分钟</option>
                                </select>
                                <div class="select-arrow">
                                    <i class="fa fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>

                        <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300 select-none">
                            <input id="pullOnFocus" type="checkbox" checked
                                class="rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary/50">
                            <span>切回页面自动拉取</span>
                        </label>

                        <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300 select-none">
                            <input id="realtimeEnabled" type="checkbox"
                                class="rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary/50">
                            <span>Realtime 实时监听（需要在 Supabase 打开 replication）</span>
                        </label>

                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            建议：未添加 <span class="font-mono">op_ts</span> 列时会回退“全量拉取”，可把拉取间隔调大。
                        </p>
                    </div>

<div class="flex space-x-3 mt-3">
                        <button id="sbSaveConfigBtn" class="flex-1 bg-gray-900 hover:bg-gray-800 text-white py-2.5 rounded-lg transition-all">
                            <i class="fa fa-save mr-2"></i>保存配置
                        </button>
                        <button id="sbClearConfigBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 py-2.5 rounded-lg transition-all">
                            清除
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">配置项将保存在本机浏览器中（localStorage）。Anon Key 可公开使用，但不要把 Service Role Key 放到前端。</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-300 mb-1">邮箱</label>
                        <input id="authEmail" type="email" placeholder="you@example.com"
                            class="w-full px-3 py-2 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-primary/40 focus:border-primary outline-none" />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-300 mb-1">密码</label>
                        <input id="authPassword" type="password" placeholder="••••••••"
                            class="w-full px-3 py-2 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-primary/40 focus:border-primary outline-none" />
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button id="signInBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-2.5 rounded-lg transition-all">
                        <i class="fa fa-sign-in mr-2"></i>登录
                    </button>
                    <button id="signUpBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 py-2.5 rounded-lg transition-all">
                        <i class="fa fa-user-plus mr-2"></i>注册
                    </button>
                </div>

                <p id="authMsg" class="text-sm text-red-600 dark:text-red-400 hidden"></p>

                <div class="text-xs text-gray-500 dark:text-gray-400">
                    <div>提示：</div>
                    <ul class="list-disc ml-5 mt-1 space-y-1">
                        <li>如果你在 Supabase 开启了邮箱验证，注册后需要先去邮箱点确认链接。</li>
                        <li>登录成功后，本系统会为该账号创建独立的本地 IndexedDB 库：<code class="px-1 py-0.5 rounded bg-gray-100 dark:bg-gray-800">vip_manager_&lt;userId&gt;</code>。</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 导航栏 -->
    <nav class="bg-white dark:bg-dark shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- 小屏：标题与搜索/按钮分行；避免“添加用户”被挤成竖排/错位 -->
            <div class="flex flex-col sm:flex-row sm:justify-between gap-2 py-2 sm:py-0 sm:h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center whitespace-nowrap">
                        <i class="fa fa-diamond text-primary text-2xl mr-2"></i>
                        <span class="text-lg sm:text-xl font-bold text-primary">VIP用户管理系统</span>
                    </div>
                </div>

                <div class="flex items-center w-full sm:w-auto gap-2 sm:gap-4">
                    <div class="relative flex-1 sm:flex-none min-w-0">
                        <input type="text" id="globalSearch" placeholder="搜索用户..."
                            class="w-full sm:w-64 pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>

                    <button id="addNewUserBtn"
                        class="bg-primary hover:bg-primary/90 text-white px-3 sm:px-4 py-2 rounded-lg flex items-center transition-all whitespace-nowrap shrink-0">
                        <i class="fa fa-plus-circle sm:mr-2"></i>
                        <span class="hidden sm:inline">添加用户</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区 -->
    <div class="flex flex-1 overflow-hidden">
        <!-- 侧边栏 -->
        <aside class="w-64 bg-white dark:bg-dark shadow-md flex-shrink-0 hidden md:block">
            <div class="py-6 px-4">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-light">用户管理</h2>
                    <div class="flex space-x-2">
                        <button id="refreshBtn"
                            class="p-1.5 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            <i class="fa fa-refresh text-gray-500 dark:text-gray-300"></i>
                        </button>
                        <button id="settingsBtn"
                            class="p-1.5 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            <i class="fa fa-cog text-gray-500 dark:text-gray-300"></i>
                        </button>
                    </div>
                </div>

                <!-- 历史记录 -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">最近浏览</h3>
                        <button id="clearRecentBtn"
                            class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">清空</button>
                    </div>
                    <div id="recentUsersList" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- 动态生成内容 -->
                    </div>
                </div>

                <!-- 常用功能 -->
                <div>
                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-3">常用功能</h3>
                    <div class="space-y-1">
                        <a href="#" id="allUsersLink"
                            class="flex items-center p-2 rounded-lg bg-primary/5 text-primary common-function-link">
                            <i class="fa fa-users w-5 h-5 text-center"></i>
                            <span class="ml-3">所有用户</span>
                        </a>
                        <a href="#" id="pinnedUsersLink"
                            class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors common-function-link">
                            <i class="fa fa-star w-5 h-5 text-center"></i>
                            <span class="ml-3">置顶用户</span>
                        </a>
                        <a href="#" id="statsLink"
                            class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors common-function-link">
                            <i class="fa fa-line-chart w-5 h-5 text-center"></i>
                            <span class="ml-3">消费流水</span>
                        </a>
                        <a href="#" id="trashLink"
                            class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors common-function-link">
                            <i class="fa fa-trash w-5 h-5 text-center"></i>
                            <span class="ml-3">回收站</span>
                        </a>
                        <a href="#" id="logsLink"
                            class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors common-function-link">
                            <i class="fa fa-list-alt w-5 h-5 text-center"></i>
                            <span class="ml-3">操作日志</span>
                        </a>
                        <a href="#" id="settingsLink"
                            class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors common-function-link">
                            <i class="fa fa-cog w-5 h-5 text-center"></i>
                            <span class="ml-3">系统设置</span>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容 -->
        <main class="flex-1 overflow-y-auto bg-gray-50 dark:bg-darker p-4 sm:p-6 pb-24 md:pb-6">
            <div class="max-w-7xl mx-auto">
                <!-- 搜索和筛选 -->
                <div class="bg-white dark:bg-dark rounded-xl p-4 mb-6 shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                        <div class="flex-1">
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-light">用户列表</h1>
                            <p id="userCountText" class="text-gray-500 dark:text-gray-400 mt-1">共找到 0 个 VIP 用户</p>
                        </div>
                        <div class="flex justify-end">
                            <div class="relative">
                                <select id="filterSelect"
                                    class="pl-3 pr-10 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary appearance-none">
                                    <option value="all">全部用户</option>
                                    <option value="pinned">置顶用户</option>
                                    <option value="highBalance">余额大于500</option>
                                    <option value="midBalance">余额100-500</option>
                                    <option value="lowBalance">余额小于100</option>
                                </select>
                                <div
                                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                    <i class="fa fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用户卡片列表 -->
                <div id="usersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                    <!-- 动态生成内容 -->
                </div>

                <!-- 无用户提示 -->
                <div id="noUsersMessage" class="hidden py-12 text-center">
                    <div
                        class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 mb-4">
                        <i class="fa fa-users text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-900 dark:text-light mb-2">暂无VIP用户</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-4">点击"添加用户"按钮来创建第一个VIP用户</p>
                    <button id="addFirstUserBtn"
                        class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg flex items-center mx-auto transition-all">
                        <i class="fa fa-plus-circle mr-2"></i>
                        <span>添加用户</span>
                    </button>
                </div>

                <!-- 分页 -->
                <div id="paginationContainer" class="mt-8 flex items-center justify-between hidden">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        显示 <span id="showingFrom">1</span> 到 <span id="showingTo">0</span>，共 <span
                            id="totalUsers">0</span> 条
                    </div>
                    <div class="flex space-x-1">
                        <button id="prevPage"
                            class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-200 dark:border-gray-700 text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50"
                            disabled>
                            <i class="fa fa-chevron-left"></i>
                        </button>
                        <div id="pageNumbers" class="flex">
                            <!-- 动态生成页码 -->
                        </div>
                        <button id="nextPage"
                            class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <i class="fa fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 用户详情模态框 -->
    <div id="userDetailModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">用户详情</h2>
                    <button id="closeUserDetailModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <div class="border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                    <div class="flex items-center">
                        <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                            <i class="fa fa-user text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 id="detailUserId" class="text-2xl font-bold text-gray-900 dark:text-light">13800138000
                            </h3>
                            <p id="detailUserTail" class="text-gray-500 dark:text-gray-400">尾号: 8000</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-light dark:bg-gray-700 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-300 mb-2">当前余额</h4>
                        <p id="detailUserBalance" class="text-3xl font-bold text-primary">¥1,500.00</p>
                    </div>
                    <div class="bg-light dark:bg-gray-700 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-300 mb-2">创建日期</h4>
                        <p id="detailUserCreated" class="text-lg text-gray-800 dark:text-light">2025-01-15</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-light mb-4">操作</h3>
                    <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                        <button id="addAmountBtn"
                            class="flex-1 bg-success hover:bg-success/90 text-white py-3 rounded-lg transition-all">
                            <i class="fa fa-plus-circle mr-2"></i> 添加金额
                        </button>
                        <button id="subtractAmountBtn"
                            class="flex-1 bg-danger hover:bg-danger/90 text-white py-3 rounded-lg transition-all">
                            <i class="fa fa-minus-circle mr-2"></i> 减少金额
                        </button>
                        <button id="togglePinBtn"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg transition-all">
                            <i class="fa fa-star mr-2"></i> 置顶用户
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-light mb-4">历史记录</h3>
                    <div id="userHistoryList" class="space-y-4 max-h-64 overflow-y-auto">
                        <!-- 动态生成内容 -->
                    </div>

                    <div class="mt-4 text-center">
                        <button id="loadMoreHistoryBtn"
                            class="text-primary hover:text-primary/80 font-medium transition-colors hidden">
                            查看更多记录 <i class="fa fa-chevron-down ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加金额模态框 -->
    <div id="addAmountModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">添加金额</h2>
                    <button id="closeAddAmountModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label for="addAmountInput"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">金额 (元)</label>
                    <input type="number" id="addAmountInput"
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                        placeholder="输入金额">
                </div>

                <div class="mb-6">
                    <label for="addDescriptionInput"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">备注</label>
                    <textarea id="addDescriptionInput" rows="3"
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                        placeholder="输入备注信息（可选）"></textarea>
                </div>

                <div class="flex space-x-3">
                    <button id="cancelAddAmount"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 dark:text-gray-900 py-3 rounded-lg transition-all">
                        取消
                    </button>
                    <button id="confirmAddAmount"
                        class="flex-1 bg-success hover:bg-success/90 text-white py-3 rounded-lg transition-all">
                        确认添加
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 减少金额模态框 -->
    <div id="subtractAmountModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">减少金额</h2>
                    <button id="closeSubtractAmountModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label for="subtractAmountInput"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">金额 (元)</label>
                    <input type="number" id="subtractAmountInput"
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                        placeholder="输入金额">
                </div>

                <div class="mb-6">
                    <label for="subtractDescriptionInput"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">备注</label>
                    <textarea id="subtractDescriptionInput" rows="3"
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                        placeholder="输入备注信息（可选）"></textarea>
                </div>

                <div class="flex space-x-3">
                    <button id="cancelSubtractAmount"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 dark:text-gray-900 py-3 rounded-lg transition-all">
                        取消
                    </button>
                    <button id="confirmSubtractAmount"
                        class="flex-1 bg-danger hover:bg-danger/90 text-white py-3 rounded-lg transition-all">
                        确认减少
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div id="addUserModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">添加用户</h2>
                    <button id="closeAddUserModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-4 flex border-b border-gray-200 dark:border-gray-700">
                    <button id="newUserTab"
                        class="flex-1 py-2 font-medium border-b-2 border-primary text-primary">新用户</button>
                    <button id="oldUserTab"
                        class="flex-1 py-2 font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent">旧用户</button>
                </div>

                <!-- 新用户表单 -->
                <div id="newUserForm" class="mb-4">
                    <div class="mb-4">
                        <label for="newUserPhone"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">手机号 (11位)</label>
                        <input type="text" id="newUserPhone"
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            placeholder="输入手机号">
                        <p id="phoneError" class="text-danger text-xs mt-1 hidden">请输入有效的11位手机号</p>
                    </div>

                    <div class="mb-6">
                        <label for="newUserInitialAmount"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">初始金额 (元)</label>
                        <input type="number" id="newUserInitialAmount"
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            placeholder="输入初始金额" value="0">
                    </div>
                </div>

                <!-- 旧用户表单 -->
                <div id="oldUserForm" class="mb-4 hidden">
                    <div class="mb-4">
                        <label for="oldUserTail"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">尾号 (4位数字)</label>
                        <input type="text" id="oldUserTail"
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            placeholder="输入4位尾号">
                        <p id="tailError" class="text-danger text-xs mt-1 hidden">请输入有效的4位尾号</p>
                    </div>

                    <div class="mb-6">
                        <label for="oldUserInitialAmount"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">初始金额 (元)</label>
                        <input type="number" id="oldUserInitialAmount"
                            class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                            placeholder="输入初始金额" value="0">
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button id="cancelAddUser"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 dark:text-gray-900 py-3 rounded-lg transition-all">
                        取消
                    </button>
                    <button id="confirmAddUser"
                        class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 rounded-lg transition-all">
                        确认添加
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除用户确认模态框 -->
    <div id="deleteUserModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-danger/10 mb-4">
                        <i class="fa fa-exclamation-triangle text-danger text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">确认删除</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">您确定要删除该用户吗？此操作不可撤销。</p>
                </div>

                <div class="flex space-x-3">
                    <button id="cancelDeleteUser"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 dark:text-gray-900 py-3 rounded-lg transition-all">
                        取消
                    </button>
                    <button id="confirmDeleteUser"
                        class="flex-1 bg-danger hover:bg-danger/90 text-white py-3 rounded-lg transition-all">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑历史记录模态框 -->
    <div id="editHistoryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">编辑历史记录</h2>
                    <button id="closeEditHistoryModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label for="editHistoryType"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">操作类型</label>
                    <select id="editHistoryType"
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        <option value="add">充值</option>
                        <option value="subtract">消费</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="editHistoryAmount"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">金额 (元)</label>
                    <input type="number" id="editHistoryAmount"
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                        placeholder="输入金额">
                </div>

                <div class="mb-6">
                    <label for="editHistoryDescription"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">备注</label>
                    <textarea id="editHistoryDescription" rows="3"
                        class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                        placeholder="输入备注信息（可选）"></textarea>
                </div>

                <div class="flex space-x-3">
                    <button id="cancelEditHistory"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 dark:text-gray-900 py-3 rounded-lg transition-all">
                        取消
                    </button>
                    <button id="confirmEditHistory"
                        class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 rounded-lg transition-all">
                        确认修改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除历史记录确认模态框 -->
    <div id="deleteHistoryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-danger/10 mb-4">
                        <i class="fa fa-exclamation-triangle text-danger text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">确认删除</h2>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">您确定要删除这条历史记录吗？此操作不可撤销。</p>
                </div>

                <div class="flex space-x-3">
                    <button id="cancelDeleteHistory"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 dark:text-gray-900 py-3 rounded-lg transition-all">
                        取消
                    </button>
                    <button id="confirmDeleteHistory"
                        class="flex-1 bg-danger hover:bg-danger/90 text-white py-3 rounded-lg transition-all">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-[92vw] sm:w-full sm:max-w-md max-h-[85vh] overflow-y-auto overflow-x-hidden sm:max-h-none sm:overflow-y-visible sm:overflow-x-hidden">
            <div class="p-4 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">系统设置</h2>
                    <button id="closeSettingsModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label for="usersPerPage"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">每页显示用户数</label>
                    <div class="relative">
                        <select id="usersPerPage"
                            class="w-full pl-3 pr-10 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary appearance-none">
                            <option value="6">6</option>
                            <option value="12">12</option>
                            <option value="24">24</option>
                            <option value="48">48</option>
                        </select>
                        <div class="select-arrow">
                            <i class="fa fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="currencySelect"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">默认货币</label>
                    <div class="relative">
                        <select id="currencySelect"
                            class="w-full pl-3 pr-10 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light bg-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary appearance-none">
                            <option value="CNY">人民币 (CNY)</option>
                            <option value="USD">美元 (USD)</option>
                        </select>
                        <div class="select-arrow">
                            <i class="fa fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">主题</label>
                    <div class="flex space-x-2">
                        <button data-theme="light"
                            class="theme-btn bg-white border border-gray-300 rounded-lg p-2 w-10 h-10 focus:ring-2 focus:ring-primary"></button>
                        <button data-theme="dark"
                            class="theme-btn bg-gray-800 border border-gray-700 rounded-lg p-2 w-10 h-10 focus:ring-2 focus:ring-primary"></button>
                    </div>
                </div>

                
                <!-- 数据备份 / 导入导出 -->
                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-light mb-3">数据备份</h3>

                    <div class="space-y-3">
                        <div>
                            <label for="importMode" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">导入模式</label>
                            <div class="relative">
                                <select id="importMode"
                                    class="w-full pl-3 pr-10 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark text-gray-900 dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary appearance-none">
                                    <option value="overwrite">覆盖本地数据（推荐先导出备份）</option>
                                    <option value="merge_keep_local">合并：保留本地（同ID跳过导入）</option>
                                    <option value="merge_overwrite">合并：同ID用导入覆盖</option>
                                </select>
                                <div class="select-arrow">
                                    <i class="fa fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>

                        <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300 select-none">
                            <input id="autoBackupBeforeImport" type="checkbox" checked
                                class="rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary/50">
                            <span>覆盖导入前自动导出一份备份</span>
                        </label>

                        <div class="flex space-x-3">
                            <button id="exportDataBtn"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 dark:text-gray-900 py-2.5 rounded-lg transition-all">
                                <i class="fa fa-download mr-2"></i>导出JSON
                            </button>

                            <button id="importDataBtn"
                                class="flex-1 bg-primary hover:bg-primary/90 text-white py-2.5 rounded-lg transition-all">
                                <i class="fa fa-upload mr-2"></i>导入JSON
                            </button>

                            <input id="importFileInput" type="file" accept="application/json" class="hidden" />
                        </div>

                        <p id="backupStatus" class="text-xs text-gray-500 dark:text-gray-400 hidden"></p>
                    </div>
                </div>


                <!-- 云端同步 / 账号 -->
                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-sm font-semibold text-gray-900 dark:text-light mb-2">云端同步（Supabase）</h3>
                    <div class="text-xs text-gray-600 dark:text-gray-300">当前账号：<span id="authEmailLabel" class="font-mono">未登录</span></div>

                    <div class="flex space-x-3 mt-3">
                        <button id="syncNowBtn"
                            class="flex-1 bg-primary hover:bg-primary/90 text-white py-2.5 rounded-lg transition-all">
                            <i class="fa fa-cloud mr-2"></i>立即同步
                        </button>
                        <button id="logoutBtn"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 py-2.5 rounded-lg transition-all">
                            <i class="fa fa-sign-out mr-2"></i>退出登录
                        </button>
                    </div>

                    <p id="syncStatus" class="text-xs text-gray-500 dark:text-gray-400 mt-2 hidden"></p>
                </div>

<div class="h-4"></div>

<div class="flex space-x-3">
                    <button id="cancelSettings"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 dark:text-gray-900 py-3 rounded-lg transition-all">
                        取消
                    </button>
                    <button id="saveSettings"
                        class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 rounded-lg transition-all">
                        保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 回收站模态框（独立窗口） -->
    <div id="trashModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">回收站</h2>
                    <button id="closeTrashModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
    
                <div id="trashList" class="space-y-2">
                    <!-- renderTrashList() 往这里塞内容 -->
                </div>
    
                <div class="mt-4 flex flex-col sm:flex-row gap-3 justify-center">
                    <button id="clearTrashBtn"
                        class="bg-danger hover:bg-danger/90 text-white px-4 py-2 rounded-lg transition-all">
                        清空回收站
                    </button>
                    <button id="closeTrashBtn"
                        class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作日志模态框（独立窗口） -->
    <div id="logsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">操作日志</h2>
                    <button id="closeLogsModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
    
                <!-- 顶部工具条 -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
                    <!-- 左侧：说明 + 筛选 -->
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 min-w-0">
                        <div class="text-sm text-gray-500 dark:text-gray-400 truncate">
                            仅保存在本机浏览器 localStorage
                        </div>
    
                        <select id="logTypeFilter"
                            class="text-sm px-2 py-1 rounded border border-gray-200 dark:border-gray-600 dark:bg-dark dark:text-light">
                            <option value="all">全部类型</option>
                        </select>
                    </div>
    
                    <!-- 右侧：操作按钮 -->
                    <div class="flex items-center gap-3 justify-end">
                        <!-- 如果你已经加了 exportLogsOnly() 就保留这一按钮；没有就删掉这行 -->
                        <button type="button" onclick="exportLogsOnly()"
                            class="text-sm px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-light transition-all">
                            导出 JSON
                        </button>
    
                        <button id="clearLogsBtn" class="text-sm text-danger hover:text-danger/80 font-medium">
                            清空日志
                        </button>
                    </div>
                </div>
    
                <!-- 列表 -->
                <div id="logsList" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1">
                    <!-- renderLogsList() 往这里塞内容 -->
                </div>
    
                <!-- 底部 -->
                <div class="mt-4 text-center">
                    <button id="closeLogsBtn"
                        class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- 消费统计模态框 -->
    <div id="statsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="p-6 stats-container">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-light">消费流水</h2>
                    <button id="closeStatsModal"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <div class="flex flex-wrap gap-4">
                        <div>
                            <label for="startDate"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">开始日期</label>
                            <input type="date" id="startDate"
                                class="px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        </div>
                        <div>
                            <label for="endDate"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">结束日期</label>
                            <input type="date" id="endDate"
                                class="px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 dark:bg-dark dark:text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        </div>
                        <div id="statsStatus" class="mt-2 text-sm text-gray-500 dark:text-gray-400 hidden">
                        </div>
                        <div class="self-end">
                            <button id="updateChartBtn"
                                class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
                                更新图表
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row gap-6 mb-6">
                    <!-- 左侧图表 -->
                    <div class="w-full lg:w-1/2 h-96">
                        <canvas id="consumptionChart"></canvas>
                    </div>

                    <!-- 右侧表格 -->
                    <div class="w-full lg:w-1/2 overflow-x-auto max-h-96">
                        <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
                            <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">日期
                                    </th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">期初余额
                                    </th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">充值金额
                                    </th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">消费金额
                                    </th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">期末余额
                                    </th>
                                    <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">当日净增减
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- 动态生成内容 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    <button id="closeStatsBtn"
                        class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 移动端底部导航 (仅在小屏幕显示) -->
    <div
        class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-dark shadow-lg border-t border-gray-200 dark:border-gray-700 py-2 px-4 z-20">
        <div class="flex justify-around">
            <a href="#" id="mobileUsersLink" class="flex flex-col items-center text-primary">
                <i class="fa fa-users text-lg"></i>
                <span class="text-xs mt-1">用户</span>
            </a>
            <a href="#" id="mobileStatsLink" class="flex flex-col items-center text-gray-500">
                <i class="fa fa-line-chart text-lg"></i>
                <span class="text-xs mt-1">统计</span>
            </a>
            <a href="#" id="mobileSettingsLink" class="flex flex-col items-center text-gray-500">
                <i class="fa fa-cog text-lg"></i>
                <span class="text-xs mt-1">设置</span>
            </a>
        </div>
    </div>

    <!-- 版权信息 -->
    <footer
        class="py-4 text-center text-gray-500 dark:text-gray-400 text-sm bg-white dark:bg-dark border-t border-gray-100 dark:border-gray-800">
        © pfmaxlnx@gmail.com 2019-2026 All rights reserved
    </footer>

    <!-- JavaScript -->
    <script>
        // VIP用户管理类
        class VIPManager {
            constructor() {
                this.users = {};
                this.recentViewed = [];
                this.currentUser = null;

                // 🗑️ 回收站 & 📜 日志
                this.trash = [];
                this.logs = [];

                // IndexedDB (Dexie)
                this.db = null;
                this._saveTimer = null;

                // ✅ 增量持久化（避免每次全量 bulkPut）
                this._dirtyUpserts = new Set();   // 需要 put 的 userId
                this._dirtyDeletes = new Set();   // 需要 delete 的 userId

                // ✅ 增量同步 outbox（离线优先）
                this._outboxMap = new Map();          // key -> op
                this._outboxDeletedKeys = new Set();  // 需要从 outbox 表删除的 key

                // ✅ 同步游标（用于增量 pull；若云端不支持对应字段，会自动回退到全量）
                this._syncState = { lastOpTs: 0, lastUpdatedAt: null };

                // ✅ 应用云端变更时：不再把变更重新写回 outbox（避免循环）
                this._suppressOps = false;
            }
    
            /**
             * 初始化：为当前登录用户打开独立的本地数据库，并加载数据
             */
            async init(userId) {
                // 重新登录时，先关闭旧库
                try { this.db?.close?.(); } catch (_) {}
                this.db = null;

                if (!window.Dexie) throw new Error('Dexie 未加载：请检查 dexie.min.js 是否成功引入');

                // 每个登录账号独立一份本地库
                this.db = new Dexie(`vip_manager_${userId}`);

                // v1：原始结构
                this.db.version(1).stores({
                    users: 'id, phone, tail, pinned, amount, created',
                    meta: 'key',
                });

                // v2：新增 outbox（增量同步）— 兼容旧库自动升级
                this.db.version(2).stores({
                    users: 'id, phone, tail, pinned, amount, created',
                    meta: 'key',
                    outbox: 'key, type, user_id, ts',
                });

                await this.db.open();

                // 尽量申请持久化存储（减少被系统自动清理的概率）
                try { await navigator.storage?.persist?.(); } catch (_) {}

                // ✅ 一次性迁移旧 localStorage（如果有）
                await this._migrateLegacyLocalStorageOnce();

                // ✅ 读取当前用户的数据到内存
                await this.loadData();
            }

            // 从 IndexedDB 加载数据（Dexie）
            async loadData() {
                if (!this.db) return;

                const allUsers = await this.db.users.toArray();
                this.users = {};
                allUsers.forEach(u => { this.users[u.id] = u; });

                this.recentViewed = (await this.db.meta.get('recentViewed'))?.value || [];
                this.trash = (await this.db.meta.get('trash'))?.value || [];
                this.logs = (await this.db.meta.get('logs'))?.value || [];
                this._syncState = (await this.db.meta.get('sync_state'))?.value || { lastOpTs: 0, lastUpdatedAt: null };

                // 加载 outbox（待同步操作）
                this._outboxMap = new Map();
                try {
                    const ops = await (this.db.outbox?.toArray?.() || []);
                    (ops || []).forEach(op => {
                        if (op && op.key) this._outboxMap.set(op.key, op);
                    });
                } catch (_) {
                    // 兼容旧库 / 某些环境 outbox 不可用
                    this._outboxMap = new Map();
                }

                // 清空本次 dirty 标记（刚 load 完属于“已落盘”状态）
                this._dirtyUpserts.clear();
                this._dirtyDeletes.clear();
                this._outboxDeletedKeys.clear();
            }
    
            // 保存数据到 IndexedDB（Dexie）——轻度防抖，避免频繁写入
            saveData() {
                if (!this.db) return; // 未初始化（未登录）时，不写入
                clearTimeout(this._saveTimer);
                this._saveTimer = setTimeout(() => {
                    this._flushSave().catch(err => console.error('[saveData]', err));
                }, 200);
            }

            async _flushSave() {
                if (!this.db) return;

                const upsertIds = Array.from(this._dirtyUpserts);
                const deleteIds = Array.from(this._dirtyDeletes);
                const outboxItems = Array.from(this._outboxMap.values());
                const outboxDeleteKeys = Array.from(this._outboxDeletedKeys);

                const tables = [this.db.users, this.db.meta];
                if (this.db.outbox) tables.push(this.db.outbox);

                await this.db.transaction('rw', tables, async () => {
                    // 1) users：只写入发生变化的那几条
                    if (deleteIds.length) {
                        await this.db.users.bulkDelete(deleteIds);
                    }
                    if (upsertIds.length) {
                        const rows = upsertIds.map(id => this.users[id]).filter(Boolean);
                        if (rows.length) await this.db.users.bulkPut(rows);
                    }

                    // 2) outbox：增量同步的待办队列
                    if (this.db.outbox) {
                        if (outboxItems.length) await this.db.outbox.bulkPut(outboxItems);
                        if (outboxDeleteKeys.length) await this.db.outbox.bulkDelete(outboxDeleteKeys);
                    }

                    // 3) meta：小数据，直接覆盖即可
                    await this.db.meta.put({ key: 'recentViewed', value: this.recentViewed });
                    await this.db.meta.put({ key: 'trash', value: this.trash });
                    await this.db.meta.put({ key: 'logs', value: this.logs });
                    await this.db.meta.put({ key: 'sync_state', value: this._syncState });
                });

                // 清空 dirty 标记
                this._dirtyUpserts.clear();
                this._dirtyDeletes.clear();
                this._outboxDeletedKeys.clear();
            }

// 立即落盘（用于“同步前先把 outbox 写进去”）
async flushNow() {
    if (!this.db) return;
    clearTimeout(this._saveTimer);
    await this._flushSave();
}

getSyncState() {
    return this._syncState || { lastOpTs: 0, lastUpdatedAt: null };
}

setSyncState(nextState) {
    this._syncState = nextState || { lastOpTs: 0, lastUpdatedAt: null };
    this.saveData();
}

// 内部：标记用户发生变更（upsert）
_onUserUpsert(userId) {
    const id = String(userId || '');
    const user = this.users[id];
    if (!id || !user) return;

    const ts = Date.now();
    user.__ts = ts; // 本地“最后修改时间”（用于冲突调试/未来增量同步）

    // 本地落盘
    this._dirtyUpserts.add(id);
    this._dirtyDeletes.delete(id);

    // outbox（仅在正常用户操作时写入；应用云端变更时 suppress）
    if (!this._suppressOps) {
        const upKey = `upsert:${id}`;
        const delKey = `delete:${id}`;

        this._outboxMap.set(upKey, { key: upKey, type: 'upsert', user_id: id, payload: user, ts });

        // 如果之前排队了 delete，则撤销 delete
        if (this._outboxMap.has(delKey)) {
            this._outboxMap.delete(delKey);
            this._outboxDeletedKeys.add(delKey);
        }
        // ✅ 自动同步（防止你忘记点“同步”）
        window.scheduleAutoSync?.('upsert');
    }

    this.saveData();
}

// 内部：标记用户被删除（tombstone）
_onUserDelete(userId) {
    const id = String(userId || '');
    if (!id) return;

    // 本地落盘
    this._dirtyDeletes.add(id);
    this._dirtyUpserts.delete(id);

    if (!this._suppressOps) {
        const ts = Date.now();
        const delKey = `delete:${id}`;
        const upKey = `upsert:${id}`;

        this._outboxMap.set(delKey, { key: delKey, type: 'delete', user_id: id, payload: null, ts });

        // 如果之前排队了 upsert，则撤销 upsert
        if (this._outboxMap.has(upKey)) {
            this._outboxMap.delete(upKey);
            this._outboxDeletedKeys.add(upKey);
        }
        // ✅ 自动同步（防止你忘记点“同步”）
        window.scheduleAutoSync?.('delete');
    }

    this.saveData();
}

// 供同步使用：获取 outbox（按时间升序）
getOutboxOps() {
    return Array.from(this._outboxMap.values())
        .filter(Boolean)
        .sort((a, b) => (a.ts || 0) - (b.ts || 0));
}

// 供同步使用：清除已成功 push 的 outbox
async clearOutboxKeys(keys) {
    const arr = Array.isArray(keys) ? keys : [];
    arr.forEach(k => {
        if (this._outboxMap.has(k)) {
            this._outboxMap.delete(k);
            this._outboxDeletedKeys.add(k);
        }
    });
    this.saveData();
}

// 供同步使用：应用云端变更（不会写回 outbox）
applyRemoteRows(rows) {
    const list = Array.isArray(rows) ? rows : [];
    let upserts = 0, deletes = 0;

    // ✅ 新语义：
    // - vip_users.deleted = true  => 进入回收站（可恢复）
    // - vip_users.purged  = true  => 彻底删除 tombstone（不显示，用于多端一致性）
    this._suppressOps = true;
    try {
        list.forEach(row => {
            const id = String(row?.user_id || '');
            if (!id) return;

            const data = (row && row.data && typeof row.data === 'object') ? row.data : {};
            const deleted = Boolean((row && typeof row.deleted === 'boolean') ? row.deleted : data.deleted);
            const purged = Boolean((row && typeof row.purged === 'boolean') ? row.purged : data.purged);

            const prev = this.users[id] || {};
            const next = {
                ...prev,
                ...data,
                id,
                deleted,
                purged,
            };

            // 尽量保留删除时间（如果云端没有，则本地补一个）
            if (deleted && !next._deletedAt) next._deletedAt = Date.now();
            if (purged && !next._purgedAt) next._purgedAt = Date.now();

            this.users[id] = next;

            // 标记脏写入（保存到 IndexedDB）
            this._dirtyUpserts.add(id);
            this._dirtyDeletes.delete(id);

            // 删除/彻底删除：从最近浏览移除
            if (deleted || purged) {
                this.recentViewed = Array.isArray(this.recentViewed)
                    ? this.recentViewed.filter(x => x !== id)
                    : [];
            }

            upserts += 1;
        });
    } finally {
        this._suppressOps = false;
    }

    this.saveData();
    return { upserts, deletes };
}

            // 迁移旧 localStorage → IndexedDB（只做一次）
            async _migrateLegacyLocalStorageOnce() {
                if (!this.db) return;
    
                const migrated = await this.db.meta.get('legacy_migrated_v1');
                if (migrated?.value) return;
    
                const legacyUsersRaw = localStorage.getItem('vipManagerUsers');
                const legacyRecentRaw = localStorage.getItem('recentViewed');
                const legacyTrashRaw = localStorage.getItem('vipManagerTrash');
                const legacyLogsRaw = localStorage.getItem('vipManagerLogs');
    
                // 没有任何旧数据，也标记成已迁移（避免每次打开都检查）
                if (!legacyUsersRaw && !legacyRecentRaw && !legacyTrashRaw && !legacyLogsRaw) {
                    await this.db.meta.put({ key: 'legacy_migrated_v1', value: true, at: Date.now() });
                    return;
                }
    
                let legacyUsers = {};
                try { legacyUsers = legacyUsersRaw ? JSON.parse(legacyUsersRaw) : {}; } catch (_) { legacyUsers = {}; }
    
                let legacyRecent = [];
                let legacyTrash = [];
                let legacyLogs = [];
                try { legacyRecent = legacyRecentRaw ? JSON.parse(legacyRecentRaw) : []; } catch (_) {}
                try { legacyTrash = legacyTrashRaw ? JSON.parse(legacyTrashRaw) : []; } catch (_) {}
                try { legacyLogs = legacyLogsRaw ? JSON.parse(legacyLogsRaw) : []; } catch (_) {}
    
                const userArr = Object.values(legacyUsers);
    
                await this.db.transaction('rw', this.db.users, this.db.meta, async () => {
                    if (userArr.length) await this.db.users.bulkPut(userArr);
                    await this.db.meta.put({ key: 'recentViewed', value: legacyRecent });
                    await this.db.meta.put({ key: 'trash', value: legacyTrash });
                    await this.db.meta.put({ key: 'logs', value: legacyLogs });
                    await this.db.meta.put({ key: 'legacy_migrated_v1', value: true, at: Date.now() });
                });
    
                // 迁移完清理旧 localStorage（避免重复导入）
                localStorage.removeItem('vipManagerUsers');
                localStorage.removeItem('recentViewed');
                localStorage.removeItem('vipManagerTrash');
                localStorage.removeItem('vipManagerLogs');
            }
    
            addLog(entry) {
                this.logs = Array.isArray(this.logs) ? this.logs : [];
                this.logs.unshift({
                    at: Date.now(),
                    ...entry
                });
                // 可选：限制长度，避免无限增长
                this.logs = this.logs.slice(0, 500);
                this.saveData();
                // ✅ meta 也需要自动同步（否则只改日志时要等别的操作才会上云）
                window.scheduleAutoSync?.('logs');
            }
    
            clearLogs() {
                this.logs = [];
                this.saveData();
                window.scheduleAutoSync?.('logs');
                return true;
            }
    
    // 获取所有用户（默认不包含 deleted/purged）
            getAllUsers(options = {}) {
                const opts = options || {};
                const includeDeleted = Boolean(opts.includeDeleted);
                const includePurged = Boolean(opts.includePurged);

                const list = Object.values(this.users || {});
                return list.filter(u => {
                    const del = Boolean(u && u.deleted);
                    const purged = Boolean(u && u.purged);
                    if (!includePurged && purged) return false;
                    if (!includeDeleted && del) return false;
                    return true;
                });
            }

            // 获取回收站用户（deleted=true 且未 purged）
            getTrashUsers() {
                return this.getAllUsers({ includeDeleted: true, includePurged: false })
                    .filter(u => Boolean(u && u.deleted) && !Boolean(u && u.purged));
            }

// 获取用户
            getUser(userId) {
                return this.users[userId];
            }

            // 添加新用户（手机号）
            addNewUser(phone, initialAmount = 0) {
                const userId = phone;

                if (this.users[userId]) {
                    return false;
                }

                const newUser = {
                    id: userId,
                    phone: phone,
                    tail: phone.slice(-4),
                    amount: parseFloat(initialAmount),
                    pinned: false,
                    history: initialAmount > 0 ? [
                        {
                            id: this.generateHistoryId(),
                            type: 'add',
                            amount: parseFloat(initialAmount),
                            date: new Date().toISOString(),
                            description: '初始充值'
                        }
                    ] : [],
                    created: new Date().toISOString()
                };

                this.users[userId] = newUser;
                this._onUserUpsert(userId);
                return true;
            }

            // 添加旧用户（尾号）
            addOldUser(tail, initialAmount = 0) {
                const userId = 'old-' + tail;

                if (this.users[userId]) {
                    return false;
                }

                const newUser = {
                    id: userId,
                    phone: '0000000' + tail,
                    tail: tail,
                    amount: parseFloat(initialAmount),
                    pinned: false,
                    history: initialAmount > 0 ? [
                        {
                            id: this.generateHistoryId(),
                            type: 'add',
                            amount: parseFloat(initialAmount),
                            date: new Date().toISOString(),
                            description: '初始充值'
                        }
                    ] : [],
                    created: new Date().toISOString()
                };

                this.users[userId] = newUser;
                this._onUserUpsert(userId);
                return true;
            }


            // 删除用户：移入回收站（软删除：deleted=true，可恢复）
            deleteUser(userId) {
                const id = String(userId || '');
                if (!id || !this.users[id]) return false;

                const user = this.users[id];

                // ✅ 软删除：不从 users 中移除，只标记 deleted=true
                user.deleted = true;
                user.purged = false;
                user._deletedAt = Date.now();

                // 记录日志
                this.logs = Array.isArray(this.logs) ? this.logs : [];
                this.logs.unshift({
                    type: 'MOVE_TO_TRASH',
                    at: Date.now(),
                    userId: id,
                    phone: user.phone || '',
                    tail: user.tail || '',
                    note: '移入回收站（deleted=true）'
                });

                // 作为一次 upsert 同步到云端 vip_users（而不是 vip_meta）
                this._onUserUpsert(id);
                return true;
            }

            // 回收站：彻底删除单条（不可恢复）——将 purged=true（不再显示）
            purgeTrashItem(userId) {
                const id = String(userId || '');
                if (!id || !this.users[id]) return false;

                const user = this.users[id];
                // ✅ 彻底删除：保留一条 tombstone（deleted=true & purged=true），用于多端同步清理
                user.deleted = true;
                user.purged = true;
                user._purgedAt = Date.now();

                this.logs = Array.isArray(this.logs) ? this.logs : [];
                this.logs.unshift({
                    type: 'PURGE_USER',
                    at: Date.now(),
                    userId: id,
                    phone: user.phone || '',
                    tail: user.tail || '',
                    note: '回收站彻底删除（purged=true）'
                });

                this._onUserUpsert(id);
                return true;
            }

            // 回收站：清空（不可恢复）——将所有 deleted=true 的用户标记 purged=true
            clearTrash() {
                const trashUsers = this.getTrashUsers();
                const count = trashUsers.length;

                if (count === 0) return true;

                trashUsers.forEach(u => {
                    if (!u) return;
                    u.deleted = true;
                    u.purged = true;
                    u._purgedAt = Date.now();
                    this._onUserUpsert(u.id);
                });

                this.logs = Array.isArray(this.logs) ? this.logs : [];
                this.logs.unshift({
                    type: 'CLEAR_TRASH',
                    at: Date.now(),
                    count,
                    note: '清空回收站（批量 purged=true）'
                });

                return true;
            }

            // 从回收站恢复用户（deleted=false）
            restoreFromTrash(userId) {
                const id = String(userId || '');
                if (!id || !this.users[id]) return false;

                const user = this.users[id];
                user.deleted = false;
                user.purged = false;
                delete user._deletedAt;
                delete user._purgedAt;

                this.logs = Array.isArray(this.logs) ? this.logs : [];
                this.logs.unshift({
                    type: 'RESTORE_USER',
                    at: Date.now(),
                    userId: id,
                    phone: user.phone || '',
                    tail: user.tail || '',
                    note: '从回收站恢复（deleted=false）'
                });

                this._onUserUpsert(id);
                return true;
            }


            // 添加金额
            addAmount(userId, amount, description = '') {
                const user = this.users[userId];
                if (user) {
                    user.amount += parseFloat(amount);
                    user.history.unshift({
                        id: this.generateHistoryId(),
                        type: 'add',
                        amount: parseFloat(amount),
                        date: new Date().toISOString(),
                        description: description
                    });
                    this._onUserUpsert(userId);
                    return true;
                }
                return false;
            }

            // 减少金额
            subtractAmount(userId, amount, description = '') {
                const user = this.users[userId];
                if (user && user.amount >= parseFloat(amount)) {
                    user.amount -= parseFloat(amount);
                    user.history.unshift({
                        id: this.generateHistoryId(),
                        type: 'subtract',
                        amount: parseFloat(amount),
                        date: new Date().toISOString(),
                        description: description
                    });
                    this._onUserUpsert(userId);
                    return true;
                }
                return false;
            }

            // 切换用户置顶状态
            togglePin(userId) {
                const user = this.users[userId];
                if (user) {
                    user.pinned = !user.pinned;
                    this._onUserUpsert(userId);
                    return user.pinned;
                }
                return false;
            }

            // 编辑历史记录
            editHistory(userId, historyId, newData) {
                const user = this.users[userId];
                if (!user) return false;

                const historyIndex = user.history.findIndex(h => h.id === historyId);
                if (historyIndex === -1) return false;

                const oldRecord = user.history[historyIndex];
                const oldAmount = oldRecord.amount;
                const oldType = oldRecord.type;

                // ✅ 用临时变量计算新余额
                let tempAmount = user.amount;

                // 回滚旧记录
                if (oldType === 'add') {
                    tempAmount -= oldAmount;
                } else {
                    tempAmount += oldAmount;
                }

                // 应用新记录
                const newAmount = parseFloat(newData.amount);
                if (newData.type === 'add') {
                    tempAmount += newAmount;
                } else {
                    tempAmount -= newAmount;
                }

                // ❌ 余额不能为负
                if (tempAmount < 0) {
                    return false;
                }

                // ✅ 真正应用
                user.amount = tempAmount;

                user.history[historyIndex] = {
                    id: historyId,
                    type: newData.type,
                    amount: newAmount,
                    date: oldRecord.date,
                    description: newData.description
                };

                this._onUserUpsert(userId);
                return true;
            }


            // 删除历史记录
            deleteHistory(userId, historyId) {
                const user = this.users[userId];
                if (user) {
                    const historyIndex = user.history.findIndex(h => h.id === historyId);
                    if (historyIndex !== -1) {
                        const record = user.history[historyIndex];

                        // 调整用户余额
                        if (record.type === 'add') {
                            user.amount -= record.amount;
                        } else {
                            user.amount += record.amount;
                        }

                        user.history.splice(historyIndex, 1);
                        this._onUserUpsert(userId);
                        return true;
                    }
                }
                return false;
            }

            // 搜索用户
            searchUsers(query) {
                if (!query) {
                    return this.getAllUsers();
                }

                query = query.toLowerCase();
                return this.getAllUsers().filter(user =>
                    user.phone.includes(query) ||
                    user.tail.includes(query) ||
                    user.id.includes(query)
                );
            }

            // 筛选用户
            filterUsers(filterType) {
            const users = this.getAllUsers();

            // 防止 amount 是字符串/空值，统一转成数字
            const getAmount = (u) => Number(u?.amount ?? 0);

            const rules = {
                all: () => true,
                pinned: (u) => !!u.pinned,
                highBalance: (u) => getAmount(u) > 500,
                midBalance: (u) => {
                    const a = getAmount(u);
                    return a >= 100 && a <= 500;
                },
                lowBalance: (u) => getAmount(u) < 100,
            };

            return users.filter(rules[filterType] ?? rules.all);
        }


            // 添加最近浏览
            addRecentView(userId) {
                // 移除重复项
                this.recentViewed = this.recentViewed.filter(id => id !== userId);
                // 添加到开头
                this.recentViewed.unshift(userId);
                // 限制最多5条
                this.recentViewed = this.recentViewed.slice(0, 5);
                this.saveData();
                window.scheduleAutoSync?.('recent');
            }

            // 获取最近浏览的用户
            getRecentUsers() {
                return this.recentViewed
                    .map(id => this.getUser(id))
                    .filter(user => user !== undefined);
            }


        // 获取指定时间段的充值/消费流水数据（含期初/期末余额）
        getConsumptionData(startDate, endDate) {
            const consumptionData = [];
            const allUsers = this.getAllUsers();

            // 统一把 start/end 归一到“本地 00:00”
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            const end = new Date(endDate);
            end.setHours(0, 0, 0, 0);

            // 初始化日期范围内的数据
            const dateIndexMap = {};
            const currentDate = new Date(start);
            let i = 0;

            while (currentDate <= end) {
                const dateStr = toLocalDateKey(currentDate);
                consumptionData.push({
                    date: dateStr,
                    openingBalance: 0,
                    recharge: 0,
                    consumption: 0,
                    netChange: 0,
                    closingBalance: 0
                });
                dateIndexMap[dateStr] = i++;
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // 当前系统总余额（所有用户 amount 之和）
            const currentTotalBalance = allUsers.reduce((sum, user) => {
                return sum + (parseFloat(user.amount) || 0);
            }, 0);

            // 从 start(含) 到“现在”的累计变动（用于从当前余额回推出 start 时的期初余额）
            let deltaAfterStart = 0;

            // 汇总范围内每日充值/消费，同时计算 deltaAfterStart
            allUsers.forEach(user => {
                (user.history || []).forEach(record => {
                    const recordDate = new Date(record.date);
                    const amt = parseFloat(record.amount) || 0;

                    // 1) 回推期初余额需要：统计 start 之后发生的所有流水（含 start 当天）
                    if (recordDate >= start) {
                        if (record.type === 'subtract') {
                            deltaAfterStart -= amt;  // subtract = -amt
                        } else {
                            deltaAfterStart += amt;  // add = +amt
                        }
                    }

                    // 2) 统计区间内每天的流水（按“本地日期”归档）
                    const dateStr = toLocalDateKey(recordDate);
                    const idx = dateIndexMap[dateStr];
                    if (idx !== undefined) {
                        if (record.type === 'subtract') {
                            consumptionData[idx].consumption += amt;
                            consumptionData[idx].netChange -= amt;
                        } else {
                            consumptionData[idx].recharge += amt;
                            consumptionData[idx].netChange += amt;
                        }
                    }
                });
            });

            // start 当天 00:00 的期初总余额
            let runningBalance = currentTotalBalance - deltaAfterStart;

            // 生成每一天的期初/期末
            consumptionData.forEach(day => {
                day.openingBalance = runningBalance;
                day.closingBalance = runningBalance + day.netChange;
                runningBalance = day.closingBalance;
            });

            return consumptionData;
        }


            // 生成历史记录ID
            generateHistoryId() {
                return 'hist_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // 获取历史记录
            getHistory(userId, historyId) {
                const user = this.users[userId];
                if (user) {
                    return user.history.find(h => h.id === historyId);
                }
                return null;
            }
        }

        // —— 日期工具：按本地时区生成 YYYY-MM-DD（避免 UTC 分组导致日期偏移）——
            function toLocalDateKey(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            // HTML <input type="date"> 的值解析为“本地 00:00:00”的 Date
            function parseLocalDateInput(id) {
                const el = document.getElementById(id);
                if (!el || !el.value) return null;
                const [y, m, d] = el.value.split('-').map(Number);
                return new Date(y, m - 1, d);
            }


        // 格式化金额（带货币换算）
        function formatAmount(amount) {
            const currency = localStorage.getItem('currency') || 'CNY';
            const exchangeRate = currency === 'USD' ? 0.14 : 1; // 1 CNY = 0.14 USD
            const convertedAmount = amount * exchangeRate;
            const symbol = currency === 'USD' ? '$' : '¥';
            return symbol + convertedAmount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' +
                date.toTimeString().substring(0, 5);
        }

        // 获取操作类型文本 - 修改：现在只返回操作类型和金额，不包含备注
        function getOperationText(type, amount) {
            const action = type === 'add' ? '充值' : '消费';
            return `${action} ${formatAmount(amount)}`;
        }

        // 应用实例
        const vipManager = new VIPManager();
        let currentUserId = null;
        let currentHistoryId = null;
        let currentPage = 1;
        let usersPerPage = 6;
        let filteredUsers = [];
        let activeFilter = 'all';
        let searchQuery = '';

        // 消费统计图表实例
        let consumptionChart = null;

        // DOM元素
        const usersContainer = document.getElementById('usersContainer');
        const userCountText = document.getElementById('userCountText');
        const noUsersMessage = document.getElementById('noUsersMessage');
        const paginationContainer = document.getElementById('paginationContainer');
        const showingFrom = document.getElementById('showingFrom');
        const showingTo = document.getElementById('showingTo');
        const totalUsers = document.getElementById('totalUsers');
        const pageNumbers = document.getElementById('pageNumbers');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const recentUsersList = document.getElementById('recentUsersList');
        const filterSelect = document.getElementById('filterSelect');
        const globalSearch = document.getElementById('globalSearch');

        // 模态框
        const userDetailModal = document.getElementById('userDetailModal');
        const addAmountModal = document.getElementById('addAmountModal');
        const subtractAmountModal = document.getElementById('subtractAmountModal');
        const addUserModal = document.getElementById('addUserModal');
        const deleteUserModal = document.getElementById('deleteUserModal');
        const settingsModal = document.getElementById('settingsModal');
        const statsModal = document.getElementById('statsModal');
        const editHistoryModal = document.getElementById('editHistoryModal');
        const deleteHistoryModal = document.getElementById('deleteHistoryModal');

        // 渲染用户列表
        function renderUserList() {
            // 应用筛选和搜索
            let users = vipManager.getAllUsers();

            if (activeFilter !== 'all') {
                users = vipManager.filterUsers(activeFilter);
            }

            if (searchQuery) {
                users = vipManager.searchUsers(searchQuery);
            }

            filteredUsers = users;

            // 更新用户计数
            userCountText.textContent = `共找到 ${filteredUsers.length} 个 VIP 用户`;

            // 显示或隐藏无用户消息
            if (filteredUsers.length === 0) {
                usersContainer.innerHTML = '';
                noUsersMessage.classList.remove('hidden');
                paginationContainer.classList.add('hidden');
                return;
            } else {
                noUsersMessage.classList.add('hidden');
            }

            // 计算分页
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            currentPage = Math.min(currentPage, totalPages);

            // 显示或隐藏分页控件
            if (filteredUsers.length <= usersPerPage) {
                paginationContainer.classList.add('hidden');
            } else {
                paginationContainer.classList.remove('hidden');
            }

            // 更新分页信息
            const startIdx = (currentPage - 1) * usersPerPage;
            const endIdx = Math.min(startIdx + usersPerPage, filteredUsers.length);

            showingFrom.textContent = startIdx + 1;
            showingTo.textContent = endIdx;
            totalUsers.textContent = filteredUsers.length;

            // 生成页码
            pageNumbers.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `w-10 h-10 flex items-center justify-center rounded-lg ${i === currentPage ? 'bg-primary text-white' : 'border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                    }`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    renderUserList();
                });
                pageNumbers.appendChild(pageBtn);
            }

            // 更新上一页/下一页按钮状态
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;

            // 渲染当前页的用户
            usersContainer.innerHTML = '';
            const currentPageUsers = filteredUsers.slice(startIdx, endIdx);

            currentPageUsers.forEach(user => {
                const card = createUserCard(user);
                usersContainer.appendChild(card);
            });
        }

        
        function renderTrashList() {
            const trashList = document.getElementById('trashList');
            const trash = vipManager.getTrashUsers ? vipManager.getTrashUsers() : [];

            if (!trashList) return;

            if (!Array.isArray(trash) || trash.length === 0) {
                trashList.innerHTML = `<div class="text-sm text-gray-500 dark:text-gray-400">回收站为空</div>`;
                return;
            }

            trashList.innerHTML = trash.map((u) => {
                const label = u.phone ? u.phone : `尾号 ${u.tail || ''}`;
                const when = u._deletedAt ? new Date(u._deletedAt).toLocaleString() : '';
                return `
                  <div class="p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between gap-3">
                      <div class="min-w-0">
                        <div class="text-sm font-medium text-gray-900 dark:text-light truncate">${label}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">删除时间：${when}</div>
                      </div>
                      <div class="flex items-center gap-2 shrink-0">
                        <button class="restore-trash-btn px-3 py-1.5 text-xs rounded-md bg-green-600 hover:bg-green-700 text-white"
                          data-id="${u.id}">恢复</button>
                        <button class="purge-trash-btn px-3 py-1.5 text-xs rounded-md bg-red-600 hover:bg-red-700 text-white"
                          data-id="${u.id}">彻底删除</button>
                      </div>
                    </div>
                  </div>
                `;
            }).join('');

            // 事件委托
            trashList.onclick = (e) => {
                const restoreBtn = e.target.closest('.restore-trash-btn');
                const purgeBtn = e.target.closest('.purge-trash-btn');

                if (restoreBtn) {
                    const id = restoreBtn.getAttribute('data-id');
                    const ok = vipManager.restoreFromTrash(id);
                    if (!ok) {
                        alert('恢复失败，请重试。');
                        return;
                    }
                    renderUserList();
                    renderRecentUsers();
                    renderTrashList();
                    return;
                }

                if (purgeBtn) {
                    const id = purgeBtn.getAttribute('data-id');
                    const okToDelete = confirm('确定要彻底删除该用户吗？该操作不可恢复。');
                    if (!okToDelete) return;

                    const ok = vipManager.purgeTrashItem(id);
                    if (!ok) {
                        alert('彻底删除失败，请重试。');
                        return;
                    }
                    renderUserList();
                    renderRecentUsers();
                    renderTrashList();
                    return;
                }
            };
        }

        function renderLogsList() {
            const logsList = document.getElementById('logsList');
            const filterSelect = document.getElementById('logTypeFilter');
            const logs = Array.isArray(vipManager.logs) ? vipManager.logs : [];

            if (!logsList) return;

            // ===== 初始化类型下拉框（只在第一次或类型变化时）=====
            if (filterSelect && filterSelect.options.length <= 1) {
                const types = [...new Set(logs.map(l => l.type).filter(Boolean))];
                types.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    filterSelect.appendChild(opt);
                });
            }

            const currentType = filterSelect ? filterSelect.value : 'all';
            const filteredLogs =
                currentType === 'all'
                    ? logs
                    : logs.filter(l => l.type === currentType);

            if (filteredLogs.length === 0) {
                logsList.innerHTML =
                    `<div class="text-sm text-gray-500 dark:text-gray-400">暂无日志</div>`;
                return;
            }

            logsList.innerHTML = filteredLogs.map((log, idx) => {
                const time = log.at ? new Date(log.at).toLocaleString() : '';
                const type = log.type || 'UNKNOWN';
                const note = log.note || '';
                const who = log.phone || log.userId || '';

                return `
        <div class="p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex justify-between gap-3">
            <div class="min-w-0">
                <div class="font-medium text-gray-800 dark:text-light">
                    ${type}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    ${time} ${who ? ' · ' + who : ''}
                </div>
                ${note ? `<div class="text-sm text-gray-700 dark:text-gray-300 mt-2">${note}</div>` : ''}
            </div>

            <!-- ✅ 单条删除按钮 -->
            <button
                class="delete-log-btn text-danger text-sm hover:text-danger/80"
                data-index="${idx}">
                删除
            </button>
        </div>
        `;
            }).join('');
        }




        // 创建用户卡片

        function createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'bg-white dark:bg-dark rounded-xl overflow-hidden shadow-sm hover-scale card-shadow slide-up';

            const pinIcon = user.pinned ?
                '<i class="fa fa-star text-yellow-400"></i>' :
                '<i class="fa fa-star-o text-gray-400"></i>';

            // 获取最近操作显示文本
            let recentOperationText = '';
            if (user.history.length > 0) {
                const recent = user.history[0];
                recentOperationText = getOperationText(recent.type, recent.amount);
                if (recent.description) {
                    recentOperationText = `${recentOperationText}<div class="history-note">${recent.description}</div>`;
                }
            }

            card.innerHTML = `
                <div class="p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full ${user.pinned ? 'bg-primary/10 text-primary' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300'} flex items-center justify-center">
                                    <i class="fa fa-user"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-lg font-semibold text-gray-800 dark:text-light">${user.phone}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">尾号: ${user.tail}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-1">
                            <button class="p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors toggle-pin-btn" data-user-id="${user.id}">
                                ${pinIcon}
                            </button>
                            <button class="p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-300 transition-colors options-btn" data-user-id="${user.id}">
                                <i class="fa fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500 dark:text-gray-400">当前余额</span>
                            <span class="text-xl font-bold text-primary">${formatAmount(user.amount)}</span>
                        </div>
                        
                        <div class="mt-4 flex space-x-2">
                            <button class="flex-1 bg-success hover:bg-success/90 text-white py-2 rounded-lg transition-all add-amount-btn" data-user-id="${user.id}">
                                <i class="fa fa-plus mr-1"></i> 充值
                            </button>
                            <button class="flex-1 bg-danger hover:bg-danger/90 text-white py-2 rounded-lg transition-all subtract-amount-btn" data-user-id="${user.id}">
                                <i class="fa fa-minus mr-1"></i> 消费
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">最近操作</h4>
                        <div class="space-y-2">
                            ${user.history.slice(0, 2).map(record => `
                                <div class="flex items-center">
                                    <div class="w-2 h-2 rounded-full ${record.type === 'add' ? 'bg-success' : 'bg-danger'} mr-2"></div>
                                    <div class="flex-1">
                                        <div class="text-sm text-gray-700 dark:text-gray-300">${getOperationText(record.type, record.amount)}</div>
                                        ${record.description ? `<div class="history-note">${record.description}</div>` : ''}
                                    </div>
                                    <span class="text-xs text-gray-400">${formatDate(record.date)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            // 添加点击事件
            card.addEventListener('click', (e) => {
                // 如果点击的是按钮，不触发详情页
                if (e.target.closest('button')) return;

                currentUserId = user.id;
                openUserDetail(user.id);
            });

            // 添加充值按钮事件
            card.querySelector('.add-amount-btn').addEventListener('click', () => {
                currentUserId = user.id;
                openAddAmountModal();
            });

            // 添加消费按钮事件
            card.querySelector('.subtract-amount-btn').addEventListener('click', () => {
                currentUserId = user.id;
                openSubtractAmountModal();
            });

            // 添加置顶按钮事件
            card.querySelector('.toggle-pin-btn').addEventListener('click', (e) => {
                e.stopPropagation(); // 阻止冒泡到卡片
                toggleUserPin(user.id);
            });

            // 添加选项按钮事件
            card.querySelector('.options-btn').addEventListener('click', (e) => {
                e.stopPropagation(); // 阻止冒泡到卡片
                currentUserId = user.id;
                openDeleteUserModal();
            });

            return card;
        }

        // 打开用户详情
        function openUserDetail(userId) {
            const user = vipManager.getUser(userId);
            if (!user) return;

            // 添加到最近浏览
            vipManager.addRecentView(userId);
            renderRecentUsers();

            // 更新详情页内容
            document.getElementById('detailUserId').textContent = user.phone;
            document.getElementById('detailUserTail').textContent = `尾号: ${user.tail}`;
            document.getElementById('detailUserBalance').textContent = formatAmount(user.amount);
            document.getElementById('detailUserCreated').textContent = formatDate(user.created);

            // 更新历史记录
            const historyList = document.getElementById('userHistoryList');
            historyList.innerHTML = '';

            user.history.slice(0, 5).forEach(record => {
                const item = createHistoryItem(record, userId);
                historyList.appendChild(item);
            });

            // 显示或隐藏"查看更多"按钮
            const loadMoreBtn = document.getElementById('loadMoreHistoryBtn');
            if (user.history.length > 5) {
                loadMoreBtn.classList.remove('hidden');
                loadMoreBtn.onclick = () => {
                    // 显示全部历史记录
                    historyList.innerHTML = '';
                    user.history.forEach(record => {
                        const item = createHistoryItem(record, userId);
                        historyList.appendChild(item);
                    });
                    loadMoreBtn.classList.add('hidden');
                };
            } else {
                loadMoreBtn.classList.add('hidden');
            }

            // 更新操作按钮状态
            const togglePinBtn = document.getElementById('togglePinBtn');
            if (user.pinned) {
                togglePinBtn.innerHTML = '<i class="fa fa-star mr-2"></i> 取消置顶';
            } else {
                togglePinBtn.innerHTML = '<i class="fa fa-star mr-2"></i> 置顶用户';
            }

            // 打开模态框
            userDetailModal.classList.remove('hidden');
        }

        // 创建历史记录项 - 修改：现在备注以浅色小字显示在金额下方
        function createHistoryItem(record, userId) {
            const item = document.createElement('div');
            item.className = 'bg-white dark:bg-gray-700 rounded-lg border border-gray-100 dark:border-gray-600 p-4 shadow-sm history-item';

            const iconClass = record.type === 'add' ?
                'bg-success/10 text-success' :
                'bg-danger/10 text-danger';

            const icon = record.type === 'add' ? 'plus' : 'minus';

            item.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        <div class="w-8 h-8 rounded-full ${iconClass} flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fa fa-${icon}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-light history-record">
                                ${getOperationText(record.type, record.amount)}
                            </p>
                            ${record.description ? `<p class="history-note truncate">${record.description}</p>` : ''}
                            <p class="text-xs text-gray-500 dark:text-gray-400">${formatDate(record.date)}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1 ml-2 action-buttons history-actions">
                        <button class="p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-500 dark:text-gray-300 transition-colors edit-history-btn" data-history-id="${record.id}" title="编辑">
                            <i class="fa fa-edit text-xs"></i>
                        </button>
                        <button class="p-1.5 rounded-full hover:bg-danger/10 text-danger transition-colors delete-history-btn" data-history-id="${record.id}" title="删除">
                            <i class="fa fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `;

            // 添加编辑按钮事件
            item.querySelector('.edit-history-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                currentHistoryId = record.id;
                currentUserId = userId;
                openEditHistoryModal(userId, record.id);
            });

            // 添加删除按钮事件
            item.querySelector('.delete-history-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                currentHistoryId = record.id;
                currentUserId = userId;
                openDeleteHistoryModal(userId, record.id);
            });

            return item;
        }

        // 渲染最近浏览的用户
        function renderRecentUsers() {
            const recentUsers = vipManager.getRecentUsers();
            recentUsersList.innerHTML = '';

            if (recentUsers.length === 0) {
                recentUsersList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">暂无浏览记录</p>';
                return;
            }

            recentUsers.forEach(user => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';
                item.innerHTML = `
                    <div class="w-8 h-8 rounded-full ${user.pinned ? 'bg-primary/10 text-primary' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300'} flex items-center justify-center">
                        <i class="fa fa-user"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-700 dark:text-light">${user.phone}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">余额: ${formatAmount(user.amount)}</p>
                    </div>
                `;

                item.addEventListener('click', () => {
                    currentUserId = user.id;
                    openUserDetail(user.id);
                });

                recentUsersList.appendChild(item);
            });
        }

        // 打开添加金额模态框
        function openAddAmountModal() {
            document.getElementById('addAmountInput').value = '';
            document.getElementById('addDescriptionInput').value = '';
            addAmountModal.classList.remove('hidden');
        }

        // 打开减少金额模态框
        function openSubtractAmountModal() {
            document.getElementById('subtractAmountInput').value = '';
            document.getElementById('subtractDescriptionInput').value = '';
            subtractAmountModal.classList.remove('hidden');
        }

        // 打开添加用户模态框
        function openAddUserModal() {
            document.getElementById('newUserPhone').value = '';
            document.getElementById('oldUserTail').value = '';
            document.getElementById('newUserInitialAmount').value = '0';
            document.getElementById('oldUserInitialAmount').value = '0';
            document.getElementById('phoneError').classList.add('hidden');
            document.getElementById('tailError').classList.add('hidden');

            // 默认显示新用户表单
            document.getElementById('newUserForm').classList.remove('hidden');
            document.getElementById('oldUserForm').classList.add('hidden');
            document.getElementById('newUserTab').classList.add('border-primary', 'text-primary');
            document.getElementById('oldUserTab').classList.add('border-transparent');
            document.getElementById('oldUserTab').classList.remove('border-primary', 'text-primary');

            addUserModal.classList.remove('hidden');
        }

        // 打开删除用户模态框
        function openDeleteUserModal() {
            deleteUserModal.classList.remove('hidden');
        }

        // 打开编辑历史记录模态框
        function openEditHistoryModal(userId, historyId) {
            const record = vipManager.getHistory(userId, historyId);
            if (!record) return;

            document.getElementById('editHistoryType').value = record.type;
            document.getElementById('editHistoryAmount').value = record.amount;
            document.getElementById('editHistoryDescription').value = record.description || '';

            editHistoryModal.classList.remove('hidden');
        }

        // 打开删除历史记录模态框
        function openDeleteHistoryModal(userId, historyId) {
            deleteHistoryModal.classList.remove('hidden');
        }

        // 打开设置模态框
        function openSettingsModal() {
            // 加载保存的设置
            const savedUsersPerPage = localStorage.getItem('usersPerPage');
            if (savedUsersPerPage) {
                document.getElementById('usersPerPage').value = savedUsersPerPage;
            } else {
                document.getElementById('usersPerPage').value = usersPerPage;
            }

            // 加载货币设置
            const currency = localStorage.getItem('currency') || 'CNY';
            document.getElementById('currencySelect').value = currency;

            // 加载主题设置
            const theme = localStorage.getItem('theme') || 'light';
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-primary');
            });
            document.querySelector(`.theme-btn[data-theme="${theme}"]`).classList.add('ring-2', 'ring-primary');

                        // 重置备份状态显示
            const statusEl = document.getElementById('backupStatus');
            if (statusEl) {
                statusEl.classList.add('hidden');
                statusEl.textContent = '';
            }
            const fileInput = document.getElementById('importFileInput');
            if (fileInput) {
                fileInput.value = '';
            }

settingsModal.classList.remove('hidden');
        }

        // 打开统计模态框
        function openStatsModal() {
            statsModal.classList.remove('hidden');

            // 限制日期选择不超过今天（避免未来日期）
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().slice(0, 10); // 用于 input[max]，够用
            document.getElementById('startDate').max = todayStr;
            document.getElementById('endDate').max = todayStr;

            // 顺便清空提示
            setStatsStatus('');

            // 设置默认日期范围（最近7天，含今天共7天）
            const endDate = new Date();
            endDate.setHours(0, 0, 0, 0);

            const startDate = new Date(endDate);
            startDate.setDate(endDate.getDate() - 6);

            document.getElementById('startDate').value = toLocalDateKey(startDate);
            document.getElementById('endDate').value = toLocalDateKey(endDate);

            // 延迟绘制图表，确保模态框已完全显示
            setTimeout(() => {
                drawConsumptionChart(startDate, endDate);
            }, 50);
        }

    // 绘制充值/消费流水图表（图表只展示最近 7 天）
    function drawConsumptionChart(startDate, endDate) {
        const ctx = document.getElementById('consumptionChart').getContext('2d');

        // 全量数据：用于表格
        const flowData = vipManager.getConsumptionData(startDate, endDate);

        // 图表展示所选范围（最多 31 天）
        const chartData = flowData;

        // 销毁现有图表（如果存在）
        if (consumptionChart) {
            consumptionChart.destroy();
        }

        // 创建新图表：柱状(充值/消费) + 折线(期末余额)
        consumptionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(item => item.date),
                datasets: [
                    {
                        type: 'bar',
                        label: '消费金额',
                        data: chartData.map(item => item.consumption),
                        backgroundColor: '#F53F3F',
                        borderColor: '#F53F3F',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        type: 'bar',
                        label: '充值金额',
                        data: chartData.map(item => item.recharge),
                        backgroundColor: '#00B42A',
                        borderColor: '#00B42A',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        type: 'line',
                        label: '期末余额',
                        data: chartData.map(item => item.closingBalance),
                        borderColor: '#165DFF',
                        backgroundColor: 'rgba(22, 93, 255, 0.12)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.2,
                        yAxisID: 'yBalance'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: {
                            callback: function (value) {
                                return formatAmount(value);
                            }
                        }
                    },
                    yBalance: {
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: {
                            callback: function (value) {
                                return formatAmount(value);
                            }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${formatAmount(context.raw)}`;
                            }
                        }
                    }
                }
            }
        });

        // 强制更新图表尺寸
        setTimeout(() => {
            if (consumptionChart) consumptionChart.update();
        }, 100);

        // 更新表格数据（表格用“全量数据”，不强制 7 天）
        const tableBody = document.getElementById('statsTableBody');
        tableBody.innerHTML = '';

        flowData.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
            row.innerHTML = `
            <td class="py-3 px-4 text-sm text-gray-700 dark:text-gray-300">${item.date}</td>
            <td class="py-3 px-4 text-sm text-right text-gray-700 dark:text-gray-300">${formatAmount(item.openingBalance)}</td>
            <td class="py-3 px-4 text-sm text-right text-success">${formatAmount(item.recharge)}</td>
            <td class="py-3 px-4 text-sm text-right text-danger">${formatAmount(item.consumption)}</td>
            <td class="py-3 px-4 text-sm text-right text-gray-700 dark:text-gray-300">${formatAmount(item.closingBalance)}</td>
            <td class="py-3 px-4 text-sm text-right font-medium ${item.netChange >= 0 ? 'text-success' : 'text-danger'}">
                ${item.netChange >= 0 ? '+' : ''}${formatAmount(item.netChange)}
            </td>
        `;
            tableBody.appendChild(row);
        });
    }


        // 切换用户置顶状态
        function toggleUserPin(userId) {
            vipManager.togglePin(userId);
            renderUserList();
            renderRecentUsers();

            // 如果当前打开了用户详情页，更新按钮状态
            if (currentUserId === userId && !userDetailModal.classList.contains('hidden')) {
                const user = vipManager.getUser(userId);
                const togglePinBtn = document.getElementById('togglePinBtn');
                if (user.pinned) {
                    togglePinBtn.innerHTML = '<i class="fa fa-star mr-2"></i> 取消置顶';
                } else {
                    togglePinBtn.innerHTML = '<i class="fa fa-star mr-2"></i> 置顶用户';
                }
            }
        }

        // 应用主题设置
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // =======================
        // 数据导入 / 导出（JSON）
        // =======================

        function pad2(n) {
            return String(n).padStart(2, '0');
        }

        function formatDateForFilename(date) {
            const y = date.getFullYear();
            const m = pad2(date.getMonth() + 1);
            const d = pad2(date.getDate());
            const hh = pad2(date.getHours());
            const mm = pad2(date.getMinutes());
            const ss = pad2(date.getSeconds());
            return `${y}${m}${d}-${hh}${mm}${ss}`;
        }

        function downloadJSON(obj, filename) {
            const json = JSON.stringify(obj, null, 2);
            const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();

            setTimeout(() => URL.revokeObjectURL(url), 500);
        }

        function buildExportPayload() {
            return {
                schemaVersion: 1,
                app: '用户管理系统',
                exportedAt: new Date().toISOString(),
                data: {
                    users: vipManager.users || {},
                    recentViewed: vipManager.recentViewed || [],
                    trash: (vipManager.getTrashUsers ? vipManager.getTrashUsers() : []) || [],
                    logs: vipManager.logs || []
                },
                settings: {
                    usersPerPage: parseInt(localStorage.getItem('usersPerPage') || usersPerPage),
                    currency: localStorage.getItem('currency') || 'CNY',
                    theme: localStorage.getItem('theme') || 'light'
                }
            };
        }

        // ✅ 4.1 规范化导入数据（非常重要）
            function normalizeImportPayload(raw) {
                if (!raw || typeof raw !== 'object') {
                    return {
                        users: {},
                        recentViewed: [],
                        trash: [],
                        logs: [],
                        settings: {}
                    };
                }

                return {
                    users: raw.data?.users || {},
                    recentViewed: raw.data?.recentViewed || [],
                    trash: raw.data?.trash || [],
                    logs: raw.data?.logs || [],
                    settings: raw.settings || {}
                };
            }

        function setBackupStatus(message, isError = false) {
            const el = document.getElementById('backupStatus');
            if (!el) return;

            el.textContent = message;
            el.classList.remove('hidden');

            // 简单切换颜色（避免弹窗）
            el.classList.remove('text-gray-500', 'dark:text-gray-400', 'text-red-600', 'dark:text-red-400');
            if (isError) {
                el.classList.add('text-red-600', 'dark:text-red-400');
            } else {
                el.classList.add('text-gray-500', 'dark:text-gray-400');
            }
        }

        function setStatsStatus(message, isError = false) {
                const el = document.getElementById('statsStatus');
                if (!el) return;

                if (!message) {
                    el.textContent = '';
                    el.classList.add('hidden');
                    return;
                }

                el.textContent = message;
                el.classList.remove('hidden');

                // 清理颜色
                el.classList.remove('text-gray-500', 'dark:text-gray-400', 'text-red-600', 'dark:text-red-400');

                if (isError) {
                    el.classList.add('text-red-600', 'dark:text-red-400');
                } else {
                    el.classList.add('text-gray-500', 'dark:text-gray-400');
                }
            }

        function sanitizeUsers(usersObj) {
            const safeUsers = {};
            if (!usersObj || typeof usersObj !== 'object') return safeUsers;

            Object.entries(usersObj).forEach(([key, u]) => {
                if (!u || typeof u !== 'object') return;

                const id = u.id || key;
                const phone = u.phone || (String(id).startsWith('old-') ? ('0000000' + String(id).replace('old-', '')) : String(id));
                const tail = u.tail || String(phone).slice(-4);

                let amount = Number(u.amount);
                if (!Number.isFinite(amount)) amount = 0;

                const pinned = Boolean(u.pinned);
                const created = u.created || new Date().toISOString();

                let history = Array.isArray(u.history) ? u.history : [];
                history = history.map((h) => {
                    if (!h || typeof h !== 'object') return null;
                    const type = (h.type === 'add' || h.type === 'subtract') ? h.type : 'add';

                    let hamount = Number(h.amount);
                    if (!Number.isFinite(hamount)) hamount = 0;

                    return {
                        id: h.id || ('hist_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)),
                        type,
                        amount: hamount,
                        date: h.date || new Date().toISOString(),
                        description: h.description || ''
                    };
                }).filter(Boolean);

                safeUsers[id] = {
                    ...u,
                    id,
                    phone,
                    tail,
                    amount,
                    pinned,
                    created,
                    history
                };
            });

            return safeUsers;
        }

        function applyImportedSettings(settings) {
            if (!settings || typeof settings !== 'object') return;

            if (settings.usersPerPage) {
                const n = parseInt(settings.usersPerPage);
                if (Number.isFinite(n) && n > 0) {
                    usersPerPage = n;
                    localStorage.setItem('usersPerPage', n);
                }
            }

            if (settings.currency) {
                localStorage.setItem('currency', settings.currency);
            }

            if (settings.theme) {
                localStorage.setItem('theme', settings.theme);
                applyTheme(settings.theme);
            }
        }

        function applyImport(normalized, mode) {
            const importedUsers = sanitizeUsers(normalized.users);
            const importedRecent = Array.isArray(normalized.recentViewed) ? normalized.recentViewed : [];
            const importedTrash = Array.isArray(normalized.trash) ? normalized.trash : [];
            const importedLogs = Array.isArray(normalized.logs) ? normalized.logs : [];

            // ✅ 兼容旧备份：trash 里存的是「被删除的用户对象」
            // 新版本不再用 vipManager.trash 数组，而是用 users[id].deleted=true 表示进入回收站
            const applyTrashToUsersObj = (usersObj, trashArr) => {
                if (!usersObj || typeof usersObj !== 'object') return;
                (trashArr || []).forEach(item => {
                    if (!item) return;
                    const rawId = (typeof item === 'object') ? (item._deletedFromId || item.id) : item;
                    const id = String(rawId || '');
                    if (!id) return;

                    const base = (typeof item === 'object') ? { ...item } : {};
                    const u = usersObj[id] ? { ...usersObj[id] } : base;

                    u.id = u.id || id;
                    u.deleted = true;
                    u.purged = Boolean(u.purged);
                    if (!u._deletedAt) u._deletedAt = (typeof item === 'object' && item._deletedAt) ? item._deletedAt : Date.now();

                    delete u._deletedFromId;
                    usersObj[id] = u;
                });
            };

            // 先把 trash 叠加到导入 users（overwrite 模式也能还原回收站）
            applyTrashToUsersObj(importedUsers, importedTrash);

            let added = 0;
            let overwritten = 0;
            let skipped = 0;

            if (mode === 'overwrite') {
                vipManager.users = importedUsers;
                vipManager.recentViewed = importedRecent;
                vipManager.logs = importedLogs;

                applyImportedSettings(normalized.settings);
                vipManager.saveData();

                added = Object.keys(importedUsers || {}).length;
                return { added, overwritten, skipped };
            }

            // merge
            Object.entries(importedUsers).forEach(([id, user]) => {
                if (!vipManager.users[id]) {
                    vipManager.users[id] = user;
                    added += 1;
                } else if (mode === 'merge_overwrite') {
                    vipManager.users[id] = user;
                    overwritten += 1;
                } else {
                    skipped += 1;
                }
            });

            // 如果 trash 里有「不在 users 里的条目」，也一并导入并标记 deleted=true
            applyTrashToUsersObj(vipManager.users, importedTrash);

            // recentViewed 合并去重（按 id）
            const currentRecent = Array.isArray(vipManager.recentViewed) ? vipManager.recentViewed : [];
            const seen = new Set(currentRecent.map(x => (x && x.id) ? x.id : x));
            importedRecent.forEach(item => {
                const key = (item && item.id) ? item.id : item;
                if (!seen.has(key)) {
                    currentRecent.push(item);
                    seen.add(key);
                }
            });
            vipManager.recentViewed = currentRecent;

            // 日志：导入数据优先（没有则保留本地）
            vipManager.logs = Array.isArray(importedLogs) ? importedLogs : vipManager.logs;

            applyImportedSettings(normalized.settings);
            vipManager.saveData();
            return { added, overwritten, skipped };
        }



        
        // ==========================
        // Supabase Auth / 云端同步
        // ==========================
        const SB_URL_KEY = 'sb_url';
        const SB_ANON_KEY_KEY = 'sb_anon';

        let supabaseClient = null;
        let authedUser = null;
        function getSupabaseConfig() {
            return {
                url: (localStorage.getItem(SB_URL_KEY) || '').trim(),
                anon: (localStorage.getItem(SB_ANON_KEY_KEY) || '').trim(),
            };
        }

        function setSupabaseConfig(url, anon) {
            localStorage.setItem(SB_URL_KEY, (url || '').trim());
            localStorage.setItem(SB_ANON_KEY_KEY, (anon || '').trim());
        }

        function clearSupabaseConfig() {
            localStorage.removeItem(SB_URL_KEY);
            localStorage.removeItem(SB_ANON_KEY_KEY);
        }

        function tryInitSupabaseClient() {
            const { url, anon } = getSupabaseConfig();
            if (!url || !anon || !window.supabase?.createClient) return null;
            return supabase.createClient(url, anon, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true,
                },
            });
        }

        function setAuthMsg(msg) {
            const el = document.getElementById('authMsg');
            if (!el) return;
            if (!msg) {
                el.classList.add('hidden');
                el.textContent = '';
            } else {
                el.classList.remove('hidden');
                el.textContent = msg;
            }
        }

        function setSyncStatus(msg) {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            if (!msg) {
                el.classList.add('hidden');
                el.textContent = '';
            } else {
                el.classList.remove('hidden');
                el.textContent = msg;
            }
        }

        function updateConfigBadge() {
            const badge = document.getElementById('sbConfigBadge');
            if (!badge) return;
            const { url, anon } = getSupabaseConfig();
            if (url && anon) {
                badge.textContent = '已配置';
                badge.className = 'text-xs px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300';
            } else {
                badge.textContent = '未配置';
                badge.className = 'text-xs px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200';
            }
        }

        function showAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            overlay?.classList.remove('hidden');
            overlay?.classList.add('flex');
        }

        function hideAuthOverlay() {
            const overlay = document.getElementById('authOverlay');
            overlay?.classList.add('hidden');
            overlay?.classList.remove('flex');
        }

        function setAuthEmailLabel(text) {
            const el = document.getElementById('authEmailLabel');
            if (el) el.textContent = text || '未登录';
        }

        // 登录后初始化逻辑（改进版的 bootForUser）
            async function bootForUser(user) {
                // 预清理上次登录用户的缓存（防止数据残留）
                vipManager.users = {};
                vipManager.recentViewed = [];
                vipManager.trash = [];
                vipManager.logs = [];
                vipManager._dirtyUpserts.clear();
                vipManager._dirtyDeletes.clear();
                vipManager._outboxMap.clear();
                vipManager._outboxDeletedKeys.clear();

                // ✅ 切换账号/会话后重新探测云端表字段能力（避免缓存导致 SDK 报错）
                try { __vipUsersCapsCache = null; } catch (_) { }


                // 初始化本地 IndexedDB（关闭旧库，打开新的 vip_manager_<user.id>）
                try {
                    await vipManager.init(user.id);
                } catch (e) {
                    console.error('本地数据库初始化失败:', e);
                    setAuthMsg('本地数据库初始化失败：' + e.message);
                    showAuthOverlay();
                    return;
                }

                // 设置登录用户状态
                authedUser = user;
                setAuthEmailLabel(user.email || user.id || '已登录');

                // 刷新界面
                renderUserList();
                renderRecentUsers();
                renderTrashList();
                if (typeof renderLogsList === 'function') renderLogsList();
                hideAuthOverlay();

                // 应用云端同步设置并立即尝试拉取
                try { await applyCloudSyncSettings(false); } catch (_) { }
                try { schedulePull('startup'); } catch (_) { }
            }


        async function initAuthUI() {
            // 预填配置与输入框
            const cfg = getSupabaseConfig();
            const sbUrlInput = document.getElementById('sbUrlInput');
            const sbAnonInput = document.getElementById('sbAnonInput');
            if (sbUrlInput) sbUrlInput.value = cfg.url;
            if (sbAnonInput) sbAnonInput.value = cfg.anon;
            updateConfigBadge();

            document.getElementById('sbSaveConfigBtn')?.addEventListener('click', async () => {
                const url = (sbUrlInput?.value || '').trim();
                const anon = (sbAnonInput?.value || '').trim();
                if (!url || !anon) {
                    setAuthMsg('请先填写 Supabase Project URL 和 Anon Key。');
                    return;
                }
                setSupabaseConfig(url, anon);
                updateConfigBadge();
                setAuthMsg('');
                // 重新初始化 client
                supabaseClient = tryInitSupabaseClient();
                if (!supabaseClient) {
                    setAuthMsg('Supabase 客户端初始化失败：请检查 CDN 是否加载成功。');
                    return;
                }
                // 尝试读取 session
                const { data, error } = await supabaseClient.auth.getSession();
                if (error) {
                    setAuthMsg('读取会话失败：' + error.message);
                    return;
                }
                if (data?.session?.user) {
                    await bootForUser(data.session.user);
                } else {
                    showAuthOverlay();
                }
            });

            document.getElementById('sbClearConfigBtn')?.addEventListener('click', () => {
                clearSupabaseConfig();
                if (sbUrlInput) sbUrlInput.value = '';
                if (sbAnonInput) sbAnonInput.value = '';
                updateConfigBadge();
                setAuthMsg('已清除配置，请重新填写。');
                supabaseClient = null;
                authedUser = null;
                setAuthEmailLabel('未登录');
                showAuthOverlay();
            });

            document.getElementById('authOverlayClose')?.addEventListener('click', () => {
                // 允许关闭：进入离线本地模式（不启用云端同步）
                hideAuthOverlay();
                setAuthMsg('');
                setSyncStatus('离线模式：未登录/未配置云端同步');
            });

            // 初始化 Supabase（未配置时不要 return，否则登录/注册按钮事件不会绑定）
            supabaseClient = tryInitSupabaseClient();
            if (!supabaseClient) {
                showAuthOverlay();
                setAuthMsg('请先配置 Supabase Project URL 与 Anon Key。');
            }

            // 登录 / 注册
            document.getElementById('signInBtn')?.addEventListener('click', async () => {
                setAuthMsg('');
                const email = (document.getElementById('authEmail')?.value || '').trim();
                const password = (document.getElementById('authPassword')?.value || '').trim();
                if (!email || !password) {
                    setAuthMsg('请输入邮箱与密码。');
                    return;
                }
                supabaseClient = supabaseClient || tryInitSupabaseClient();
                if (!supabaseClient) {
                    setAuthMsg('请先填写并保存 Supabase 配置。');
                    return;
                }
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    setAuthMsg(error.message);
                    return;
                }
                if (data?.user) {
                    await bootForUser(data.user);
                }
            });

            document.getElementById('signUpBtn')?.addEventListener('click', async () => {
                setAuthMsg('');
                const email = (document.getElementById('authEmail')?.value || '').trim();
                const password = (document.getElementById('authPassword')?.value || '').trim();
                if (!email || !password) {
                    setAuthMsg('请输入邮箱与密码。');
                    return;
                }
                supabaseClient = supabaseClient || tryInitSupabaseClient();
                if (!supabaseClient) {
                    setAuthMsg('请先填写并保存 Supabase 配置。');
                    return;
                }
                const { data, error } = await supabaseClient.auth.signUp({ email, password });
                if (error) {
                    setAuthMsg(error.message);
                    return;
                }
                if (data?.session?.user) {
                    await bootForUser(data.session.user);
                } else {
                    // 可能启用了邮箱验证
                    setAuthMsg('注册成功：请到邮箱完成验证后再登录。');
                }
            });

            // 完整退出登录逻辑（在 logoutBtn 事件处理内或单独函数中）
            document.getElementById('logoutBtn')?.addEventListener('click', async () => {
                if (!supabaseClient) return;
                const oldUserId = authedUser?.id;  // 记录当前用户 ID
                // 调用 Supabase signOut 清除会话
                await supabaseClient.auth.signOut();

                // 停止后台同步任务
                try { stopAutoPull(); } catch (_) { }
                try { await stopRealtime(); } catch (_) { }

                // 清空登录状态
                authedUser = null;
                try { __vipUsersCapsCache = null; } catch (_) { }

                setAuthEmailLabel('未登录');
                setSyncStatus('');

                // 清空 vipManager 内存缓存
                vipManager.users = {};
                vipManager.recentViewed = [];
                vipManager.trash = [];
                vipManager.logs = [];

                // 关闭并删除 IndexedDB 数据库
                if (vipManager.db) {
                    try { vipManager.db.close(); } catch (_) { }
                    vipManager.db = null;
                }
                if (oldUserId) {
                    try { await Dexie.delete(`vip_manager_${oldUserId}`); } catch (_) { }
                }

                // 可选：重置 Supabase 客户端
                supabaseClient = null;

                // 显示登录界面
                showAuthOverlay();
            });


            // 设置里：立即同步（当前为“全量 upsert”演示版；后续会升级为增量 outbox）
            document.getElementById('syncNowBtn')?.addEventListener('click', async () => {
                await syncNow();
            });

            // 自动读取会话
            const { data, error } = await supabaseClient.auth.getSession();
            if (error) {
                showAuthOverlay();
                setAuthMsg('读取会话失败：' + error.message);
                return;
            }
            if (data?.session?.user) {
                await bootForUser(data.session.user);
            } else {
                showAuthOverlay();
            }

            // 监听会话变化（比如 token 刷新/登出）
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session?.user) {
                    await bootForUser(session.user);
                }
                if (event === 'SIGNED_OUT') {
                    authedUser = null;
                    try { stopAutoPull(); } catch (_) {}
                    try { await stopRealtime(); } catch (_) {}
                    try { setSyncStatus(''); } catch (_) {}
                    setAuthEmailLabel('未登录');
                    showAuthOverlay();
                }
            });
        }

        let __vipUsersCapsCache = null;

// 探测云端表是否存在可选字段（不存在则自动回退到“全量 pull”）
async function getVipUsersCaps() {
            if (__vipUsersCapsCache) return __vipUsersCapsCache;

            const caps = { updated_at: false, op_ts: false };
            if (!supabaseClient || !authedUser) return caps;

            // 注意：这里用 select 某列来探测列是否存在（不存在会返回 error）
            try {
                const { error } = await supabaseClient
                    .from('vip_users')
                    .select('updated_at')
                    .eq('owner_id', authedUser.id)
                    .limit(1);
                if (!error) caps.updated_at = true;
            } catch (_) { }

            try {
                const { error } = await supabaseClient
                    .from('vip_users')
                    .select('op_ts')
                    .eq('owner_id', authedUser.id)
                    .limit(1);
                if (!error) caps.op_ts = true;
            } catch (_) { }

            __vipUsersCapsCache = caps;
            return caps;
        }


        // =======================
        // 自动同步（可选：默认开启、可自行关闭）
        // =======================
        let __autoSyncTimer = null;
        window.__autoSyncReqId = window.__autoSyncReqId || 0;
        let __isSyncing = false;

        // ✅ 变更后尽快同步：减少“必须点一下别处才同步”的体感
        // 说明：依旧有轻量防抖，避免批量操作（如导入）触发多次同步。
        function scheduleAutoSync(reason = '') {
            try {
                if (!supabaseClient || !authedUser) return;

                // 不依赖 navigator.onLine（某些手机 WebView 不准）；失败会在 syncNow 里捕获
                try { setSyncStatus('已记录本地变更，准备同步…'); } catch (_) {}

                // 合并短时间内的多次操作：尽量“改完就同步”，同时避免疯狂触发
                clearTimeout(__autoSyncTimer);
                const reqId = (++window.__autoSyncReqId);

                const run = async () => {
                    // 如果在同步中，不丢请求：等一会儿再试（否则会出现“要点别处才同步”）
                    if (__isSyncing) {
                        __autoSyncTimer = setTimeout(run, 220);
                        return;
                    }
                    try { await syncNow(); } catch (_) {}

                    // 如果同步期间又产生了新 outbox，继续把队列排空
                    try {
                        const pending = vipManager?.getOutboxOps?.() || [];
                        if (pending.length) scheduleAutoSync('drain');
                    } catch (_) {}
                };

                __autoSyncTimer = setTimeout(() => {
                    // 如果期间又来了新请求，则这次让位（减少重复 sync）
                    if (reqId !== window.__autoSyncReqId) return;
                    run();
                }, 80);
            } catch (_) {}
        }
        window.scheduleAutoSync = scheduleAutoSync;

        // =======================
        // 自动拉取 / 切回页面拉取 / Realtime（可选）
        // =======================
        let __autoPullIntervalId = null;
        let __pullDebounceTimer = null;
        let __realtimeChannel = null;

        function getCloudSyncSettings() {
            const autoPullEnabled = (localStorage.getItem('cloud_autoPullEnabled') ?? '1') === '1';
            const autoPullIntervalSec = parseInt(localStorage.getItem('cloud_autoPullIntervalSec') || '30', 10);
            const pullOnFocus = (localStorage.getItem('cloud_pullOnFocus') ?? '1') === '1';
            const realtimeEnabled = (localStorage.getItem('cloud_realtimeEnabled') ?? '0') === '1';
            return {
                autoPullEnabled,
                autoPullIntervalSec: Number.isFinite(autoPullIntervalSec) ? autoPullIntervalSec : 30,
                pullOnFocus,
                realtimeEnabled,
            };
        }

        function setCloudSyncSettings(next) {
            const s = { ...getCloudSyncSettings(), ...(next || {}) };
            localStorage.setItem('cloud_autoPullEnabled', s.autoPullEnabled ? '1' : '0');
            localStorage.setItem('cloud_autoPullIntervalSec', String(s.autoPullIntervalSec || 30));
            localStorage.setItem('cloud_pullOnFocus', s.pullOnFocus ? '1' : '0');
            localStorage.setItem('cloud_realtimeEnabled', s.realtimeEnabled ? '1' : '0');
            return s;
        }

        function schedulePull(reason = '') {
            try {
                if (!supabaseClient || !authedUser) return;
                // ✅ 不依赖 navigator.onLine（某些手机 WebView 不准）；失败会在 syncNow 里捕获
                clearTimeout(__pullDebounceTimer);
                __pullDebounceTimer = setTimeout(async () => {
                    if (__isSyncing) return;
                    try { await syncNow(); } catch (_) { }
                }, 350);
            } catch (_) { }
        }
        window.schedulePull = schedulePull;

        function stopAutoPull() {
            if (__autoPullIntervalId) {
                clearInterval(__autoPullIntervalId);
                __autoPullIntervalId = null;
            }
        }

        function startAutoPull(intervalSec = 30) {
            stopAutoPull();
            if (!supabaseClient || !authedUser) return;
            const sec = Math.max(10, parseInt(intervalSec || 30, 10) || 30);
            __autoPullIntervalId = setInterval(() => {
                schedulePull('interval');
            }, sec * 1000);
        }

        async function stopRealtime() {
            try {
                if (supabaseClient && __realtimeChannel) {
                    await supabaseClient.removeChannel(__realtimeChannel);
                }
            } catch (_) { }
            __realtimeChannel = null;
        }

        async function startRealtime() {
            if (!supabaseClient || !authedUser) return;
            if (__realtimeChannel) return; // 已启动
            try {
                __realtimeChannel = supabaseClient
                    .channel(`vip_users_changes_${authedUser.id}`)
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'vip_users', filter: `owner_id=eq.${authedUser.id}` },
                        (_payload) => {
                            // 为了简单稳妥：收到变更就触发一次拉取（会自动增量）
                            schedulePull('realtime');
                        }
                    )
                    .subscribe((status) => {
                        // status: SUBSCRIBED / TIMED_OUT / CLOSED / CHANNEL_ERROR
                        if (status === 'SUBSCRIBED') {
                            setSyncStatus('Realtime 已连接：云端变更将自动拉取。');
                        }
                    });
            } catch (e) {
                console.warn('[realtime]', e);
                setSyncStatus('Realtime 启动失败：' + (e?.message || e));
                __realtimeChannel = null;
            }
        }

        async function applyCloudSyncSettings(fromUI = false) {
            // 从 UI 或 localStorage 读取
            let s = getCloudSyncSettings();

            const elAutoPull = document.getElementById('autoPullEnabled');
            const elInterval = document.getElementById('autoPullInterval');
            const elFocus = document.getElementById('pullOnFocus');
            const elRealtime = document.getElementById('realtimeEnabled');

            if (fromUI && elAutoPull && elInterval && elFocus && elRealtime) {
                s = setCloudSyncSettings({
                    autoPullEnabled: !!elAutoPull.checked,
                    autoPullIntervalSec: parseInt(elInterval.value || '30', 10) || 30,
                    pullOnFocus: !!elFocus.checked,
                    realtimeEnabled: !!elRealtime.checked,
                });
            } else {
                // 用 localStorage 回填 UI
                if (elAutoPull) elAutoPull.checked = s.autoPullEnabled;
                if (elInterval) elInterval.value = String(s.autoPullIntervalSec);
                if (elFocus) elFocus.checked = s.pullOnFocus;
                if (elRealtime) elRealtime.checked = s.realtimeEnabled;
            }

            // 应用：定时拉取
            stopAutoPull();
            if (s.autoPullEnabled) startAutoPull(s.autoPullIntervalSec);

            // 应用：Realtime
            await stopRealtime();
            if (s.realtimeEnabled) await startRealtime();

            return s;
        }
        window.applyCloudSyncSettings = applyCloudSyncSettings;


async function syncNow() {
            if (!supabaseClient || !authedUser) {
                setSyncStatus('未登录，无法同步。');
                return;
            }


            // ✅ 每次同步前确认会话仍有效（多端登录/长时间挂起后，避免 token 失效导致 SDK 报错）
            try {
                const { data: sessData, error: sessErr } = await supabaseClient.auth.getSession();
                if (sessErr) throw sessErr;
                const sessUser = sessData?.session?.user || null;
                if (!sessUser) {
                    setSyncStatus('会话已失效，请重新登录后再同步。');
                    try { showAuthOverlay(); } catch (_) { }
                    return;
                }
                if (authedUser?.id && sessUser?.id && authedUser.id !== sessUser.id) {
                    // 本地记录的用户与当前会话不一致：自动切换到当前会话用户
                    await bootForUser(sessUser);
                    return;
                }
            } catch (e) {
                console.warn('[sync session]', e);
                // 不强制中断：后续请求若失败会进入 catch 并给出提示
            }

            if (__isSyncing) {
                setSyncStatus('同步中…');
                return;
            }
            __isSyncing = true;
setSyncStatus('同步中…');

            // 先把本地变更落盘（确保 outbox 完整）
            try { await vipManager.flushNow(); } catch (_) {}

            const clone = (obj) => {
                try { return (typeof structuredClone === 'function') ? structuredClone(obj) : JSON.parse(JSON.stringify(obj)); }
                catch (_) { return JSON.parse(JSON.stringify(obj || null)); }
            };

            try {
                const caps = await getVipUsersCaps();

                // 1) push：仅推送 outbox（增量）
                const ops = vipManager.getOutboxOps();
                const batchSize = 200;

                if (ops.length) {
                    setSyncStatus(`同步中…正在上传本地变更（${ops.length}）`);
                }

                for (let i = 0; i < ops.length; i += batchSize) {
                    const slice = ops.slice(i, i + batchSize);
                    const rows = slice.map(op => {
                        const userId = String(op.user_id || '');
                        const ts = Number(op.ts || Date.now());

                        if (op.type === 'delete') {
                            const row = {
                                owner_id: authedUser.id,
                                user_id: userId,
                                data: { id: userId, __ts: ts },
                                deleted: true,
                            };
                            if (caps.op_ts) row.op_ts = ts;
                            if (caps.updated_at) row.updated_at = new Date(ts).toISOString();
                            return row;
                        }

                        // upsert
                        const payload = op.payload || vipManager.getUser(userId) || {};
                        const data = clone(payload);
                        data.id = data.id || userId;
                        data.__ts = typeof data.__ts === 'number' ? data.__ts : ts;

                        const row = {
                            owner_id: authedUser.id,
                            user_id: userId,
                            data,
                            deleted: Boolean(data && data.deleted),
                            purged: Boolean(data && data.purged),
                        };
                        if (caps.op_ts) row.op_ts = data.__ts;
                        if (caps.updated_at) row.updated_at = new Date(data.__ts).toISOString();
                        return row;
                    });

                    const { error } = await supabaseClient
                        .from('vip_users')
                        .upsert(rows, { onConflict: 'owner_id,user_id' });

                    if (error) throw error;

                    // 该批次成功：从 outbox 清除（即使后续失败，也能“推进进度”）
                    const keys = slice.map(op => op.key).filter(Boolean);
                    await vipManager.clearOutboxKeys(keys);
                    await vipManager.flushNow();
                }

                // 1.5) push meta（不大，但也做分离，避免影响 users 同步）
                try {
                    const metaRows = [
                        { owner_id: authedUser.id, key: 'recentViewed', value: vipManager.recentViewed },
                                                { owner_id: authedUser.id, key: 'logs', value: vipManager.logs },
                    ];
                    const { error } = await supabaseClient
                        .from('vip_meta')
                        .upsert(metaRows, { onConflict: 'owner_id,key' });
                    if (error) throw error;
                } catch (e) {
                    // meta 同步失败不阻断 users，但给出可见提示，方便排查表结构/唯一约束
                    console.warn('[sync meta]', e);
                    setSyncStatus(`vip_meta 同步失败：${e?.message || e}`);
                }

                // 2) pull：优先增量（若云端无 op_ts/updated_at，则回退全量）
                const state = vipManager.getSyncState();
                let didIncremental = false;

                let selectCols = 'user_id,data,deleted,purged';
                if (caps.op_ts) selectCols += ',op_ts';
                if (caps.updated_at) selectCols += ',updated_at';

                let q = supabaseClient
                    .from('vip_users')
                    .select(selectCols)
                    .eq('owner_id', authedUser.id);

                if (caps.op_ts && Number(state?.lastOpTs || 0) > 0) {
                    q = q.gt('op_ts', Number(state.lastOpTs));
                    didIncremental = true;
                } else if (caps.updated_at && state?.lastUpdatedAt) {
                    q = q.gt('updated_at', String(state.lastUpdatedAt));
                    didIncremental = true;
                }

                setSyncStatus(`同步中…正在下载云端变更${didIncremental ? '（增量）' : '（全量）'}`);

                let cloudUsers = null;
                let pullUsersErr = null;

                ({ data: cloudUsers, error: pullUsersErr } = await q);

                // 如果拉取出错（比如列探测误判、策略变更等），则回退全量基础字段拉取
                if (pullUsersErr) {
                    console.warn('[pull fallback]', pullUsersErr);
                    const { data, error } = await supabaseClient
                        .from('vip_users')
                        .select('user_id,data,deleted,purged')
                        .eq('owner_id', authedUser.id);
                    if (error) throw error;
                    cloudUsers = data;
                    didIncremental = false;
                    caps.op_ts = false;
                    caps.updated_at = false;
                }

                // ✅ 应用云端变更（包含 deleted=true 的 tombstone）
                const { upserts, deletes } = vipManager.applyRemoteRows(cloudUsers || []);

                // 3) pull meta
                try {
                    const { data: cloudMeta, error: pullMetaErr } = await supabaseClient
                        .from('vip_meta')
                        .select('key,value')
                        .eq('owner_id', authedUser.id);

                    if (!pullMetaErr) {
                        const metaMap = {};
                        (cloudMeta || []).forEach(r => metaMap[r.key] = r.value);

                        // 云端为主（没有则保留本地）
                        // 云端为主（没有则保留本地）；并兼容 value 被存成字符串(JSON)的情况
                        const __normMeta = (v, fallback) => {
                            if (v === undefined || v === null) return fallback;
                            if (typeof v === 'string') {
                                try { return JSON.parse(v); } catch (_) { return fallback; }
                            }
                            return v;
                        };

                        vipManager.recentViewed = __normMeta(metaMap.recentViewed, vipManager.recentViewed || []);
                                                vipManager.logs = __normMeta(metaMap.logs, vipManager.logs || []);

                        // 类型兜底：防止表结构/历史数据把数组变成对象/字符串导致 UI 异常
                        if (!Array.isArray(vipManager.recentViewed)) vipManager.recentViewed = [];
                                                if (!Array.isArray(vipManager.logs)) vipManager.logs = [];

                    }
                } catch (e) {
                    console.warn('[pull meta]', e);
                }

                // 4) 更新同步游标（用于下一次增量 pull）
                let maxTs = Number(state?.lastOpTs || 0);
                let maxUpdatedAt = state?.lastUpdatedAt || null;

                (cloudUsers || []).forEach(row => {
                    const ts =
                        (caps.op_ts && typeof row.op_ts === 'number' ? row.op_ts :
                            (row?.data && typeof row.data.__ts === 'number' ? row.data.__ts : 0));

                    if (ts) maxTs = Math.max(maxTs, ts);

                    const ua =
                        (caps.updated_at && row.updated_at ? row.updated_at :
                            (ts ? new Date(ts).toISOString() : null));

                    if (ua && (!maxUpdatedAt || ua > maxUpdatedAt)) maxUpdatedAt = ua;
                });

                // 如果这次是“全量”，同步后把游标推进到当前（避免下次仍全量）
                if (!didIncremental) {
                    const nowTs = Date.now();
                    maxTs = Math.max(maxTs, nowTs);
                    maxUpdatedAt = new Date(maxTs).toISOString();
                }

                vipManager.setSyncState({ lastOpTs: maxTs, lastUpdatedAt: maxUpdatedAt });
                await vipManager.flushNow();

                // 刷新 UI
                renderUserList();
                renderRecentUsers();
                renderTrashList();
                if (typeof renderLogsList === 'function') renderLogsList();

                setSyncStatus(`同步完成：本地上传 ${ops.length}，云端应用 +${upserts} / -${deletes}（${new Date().toLocaleString()}）`);
            } catch (e) {
                console.error(e);
                setSyncStatus('同步失败：' + (e?.message || e));
                // ✅ 常见会话/鉴权错误：自动退回登录界面，避免用户只能“清空浏览器数据”才能恢复
                try {
                    const __msg = String(e?.message || e || '');
                    const __low = __msg.toLowerCase();
                    if (__low.includes('jwt') || __low.includes('token') || __low.includes('unauthoriz') || __low.includes('forbidden') || __low.includes('session') || __low.includes('refresh')) {
                        try { await supabaseClient?.auth?.signOut?.(); } catch (_) { }
                        authedUser = null;
                        try { stopAutoPull(); } catch (_) { }
                        try { await stopRealtime(); } catch (_) { }
                        setAuthEmailLabel('未登录');
                        try { setAuthMsg('会话可能已失效，请重新登录后再试。\n' + __msg); } catch (_) { }
                        try { showAuthOverlay(); } catch (_) { }
                    }
                } catch (_) { }

            }
        
            __isSyncing = false;
}



        // 事件监听器
        document.addEventListener('DOMContentLoaded', async function () {
            // 初始化登录/同步（Supabase）
            initAuthUI();

            // 云端同步设置（回填 UI）
            try { await applyCloudSyncSettings(false); } catch (_) { }

            // 云端同步设置：监听改动（定时拉取 / Realtime）
            document.getElementById('autoPullEnabled')?.addEventListener('change', () => applyCloudSyncSettings(true));
            document.getElementById('autoPullInterval')?.addEventListener('change', () => applyCloudSyncSettings(true));
            document.getElementById('pullOnFocus')?.addEventListener('change', () => applyCloudSyncSettings(true));
            document.getElementById('realtimeEnabled')?.addEventListener('change', () => applyCloudSyncSettings(true));

            // 切回页面 / 恢复联网：自动拉取一次
            document.addEventListener('visibilitychange', () => {
                try {
                    if (document.visibilityState !== 'visible') return;
                    const s = getCloudSyncSettings();
                    if (!s.pullOnFocus) return;
                    schedulePull('visibility');
                } catch (_) { }
            });

            window.addEventListener('online', () => {
                try { schedulePull('online'); } catch (_) { }
                try { scheduleAutoSync('online'); } catch (_) { }
            });



            // 初始化用户列表和最近浏览
            renderUserList();
            renderRecentUsers();

            // 加载保存的每页用户数设置
            const savedUsersPerPage = localStorage.getItem('usersPerPage');
            if (savedUsersPerPage) {
                usersPerPage = parseInt(savedUsersPerPage);
            }

            // 加载货币设置
            const currency = localStorage.getItem('currency') || 'CNY';
            localStorage.setItem('currency', currency);

            // 加载主题设置
            const theme = localStorage.getItem('theme') || 'light';
            applyTheme(theme);
            localStorage.setItem('theme', theme);

            // 关闭模态框事件
            document.getElementById('closeUserDetailModal').addEventListener('click', () => {
                userDetailModal.classList.add('hidden');
            });

            document.getElementById('closeAddAmountModal').addEventListener('click', () => {
                addAmountModal.classList.add('hidden');
            });

            document.getElementById('closeSubtractAmountModal').addEventListener('click', () => {
                subtractAmountModal.classList.add('hidden');
            });

            document.getElementById('closeAddUserModal').addEventListener('click', () => {
                addUserModal.classList.add('hidden');
            });

            document.getElementById('closeSettingsModal').addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            document.getElementById('closeStatsModal').addEventListener('click', () => {
                statsModal.classList.add('hidden');
            });

            document.getElementById('closeStatsBtn').addEventListener('click', () => {
                statsModal.classList.add('hidden');
            });

            document.getElementById('closeEditHistoryModal').addEventListener('click', () => {
                editHistoryModal.classList.add('hidden');
            });

            document.getElementById('cancelDeleteHistory').addEventListener('click', () => {
                deleteHistoryModal.classList.add('hidden');
            });

            // 取消按钮事件
            document.getElementById('cancelAddAmount').addEventListener('click', () => {
                addAmountModal.classList.add('hidden');
            });

            document.getElementById('cancelSubtractAmount').addEventListener('click', () => {
                subtractAmountModal.classList.add('hidden');
            });

            document.getElementById('cancelAddUser').addEventListener('click', () => {
                addUserModal.classList.add('hidden');
            });

            document.getElementById('cancelDeleteUser').addEventListener('click', () => {
                deleteUserModal.classList.add('hidden');
            });

            document.getElementById('cancelSettings').addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            document.getElementById('cancelEditHistory').addEventListener('click', () => {
                editHistoryModal.classList.add('hidden');
            });

            document.getElementById('cancelDeleteHistory').addEventListener('click', () => {
                deleteHistoryModal.classList.add('hidden');
            });

            // 添加用户按钮
            document.getElementById('addNewUserBtn').addEventListener('click', openAddUserModal);
            document.getElementById('addFirstUserBtn').addEventListener('click', openAddUserModal);

            // 添加用户选项卡切换
            document.getElementById('newUserTab').addEventListener('click', function () {
                document.getElementById('newUserForm').classList.remove('hidden');
                document.getElementById('oldUserForm').classList.add('hidden');
                this.classList.remove('border-transparent');
                this.classList.add('border-primary', 'text-primary');
                document.getElementById('oldUserTab').classList.add('border-transparent');
                document.getElementById('oldUserTab').classList.remove('border-primary', 'text-primary');
            });

            document.getElementById('oldUserTab').addEventListener('click', function () {
                document.getElementById('oldUserForm').classList.remove('hidden');
                document.getElementById('newUserForm').classList.add('hidden');
                this.classList.remove('border-transparent');
                this.classList.add('border-primary', 'text-primary');
                document.getElementById('newUserTab').classList.add('border-transparent');
                document.getElementById('newUserTab').classList.remove('border-primary', 'text-primary');
            });

            // 确认添加用户
            document.getElementById('confirmAddUser').addEventListener('click', () => {
                const isNewUser = !document.getElementById('oldUserForm').classList.contains('hidden');

                if (isNewUser) {
                    // 添加旧用户
                    const tail = document.getElementById('oldUserTail').value.trim();
                    const initialAmount = document.getElementById('oldUserInitialAmount').value.trim() || '0';

                    // 验证尾号
                    const tailRegex = /^\d{4}$/;
                    if (!tailRegex.test(tail)) {
                        document.getElementById('tailError').classList.remove('hidden');
                        return;
                    }

                    document.getElementById('tailError').classList.add('hidden');

                    // 添加用户
                    if (vipManager.addOldUser(tail, initialAmount)) {
                        addUserModal.classList.add('hidden');
                        renderUserList();
                        renderRecentUsers();
                        alert('旧用户添加成功！');
                    } else {
                        alert('该用户已存在！');
                    }
                } else {
                    // 添加新用户
                    const phone = document.getElementById('newUserPhone').value.trim();
                    const initialAmount = document.getElementById('newUserInitialAmount').value.trim() || '0';

                    // 验证手机号
                    const phoneRegex = /^\d{11}$/;
                    if (!phoneRegex.test(phone)) {
                        document.getElementById('phoneError').classList.remove('hidden');
                        return;
                    }

                    document.getElementById('phoneError').classList.add('hidden');

                    // 添加用户
                    if (vipManager.addNewUser(phone, initialAmount)) {
                        addUserModal.classList.add('hidden');
                        renderUserList();
                        renderRecentUsers();
                        alert('新用户添加成功！');
                    } else {
                        alert('该用户已存在！');
                    }
                }
            });

            // 确认添加金额
            document.getElementById('confirmAddAmount').addEventListener('click', () => {
                const amount = document.getElementById('addAmountInput').value.trim();
                const description = document.getElementById('addDescriptionInput').value.trim();

                if (!amount || parseFloat(amount) <= 0) {
                    alert('请输入有效的金额！');
                    return;
                }

                if (vipManager.addAmount(currentUserId, amount, description)) {
                    addAmountModal.classList.add('hidden');
                    renderUserList();
                    renderRecentUsers();

                    // 更新详情页
                    if (!userDetailModal.classList.contains('hidden')) {
                        openUserDetail(currentUserId);
                    }

                    // ✅ 新增：写日志
                    vipManager.addLog({
                        type: 'ADD_AMOUNT',
                        userId: currentUserId,
                        note: `充值 ${amount} 元${description ? '，备注：' + description : ''}`
                    });

                    alert('金额添加成功！');
                } else {
                    alert('操作失败，请重试！');
                }
            });

            // 确认减少金额
            document.getElementById('confirmSubtractAmount').addEventListener('click', () => {
                const amount = document.getElementById('subtractAmountInput').value.trim();
                const description = document.getElementById('subtractDescriptionInput').value.trim();

                if (!amount || parseFloat(amount) <= 0) {
                    alert('请输入有效的金额！');
                    return;
                }

                const user = vipManager.getUser(currentUserId);
                if (parseFloat(amount) > user.amount) {
                    alert('减少的金额不能大于当前余额！');
                    return;
                }

                if (vipManager.subtractAmount(currentUserId, amount, description)) {
                    subtractAmountModal.classList.add('hidden');
                    renderUserList();
                    renderRecentUsers();

                    // 更新详情页
                    if (!userDetailModal.classList.contains('hidden')) {
                        openUserDetail(currentUserId);
                    }

                    vipManager.addLog({
                        type: 'SUBTRACT_AMOUNT',
                        userId: currentUserId,
                        note: `消费 ${amount} 元${description ? '，备注：' + description : ''}`
                    });

                    alert('金额减少成功！');
                } else {
                    alert('操作失败，请重试！');
                }
            });

            // 确认编辑历史记录
            document.getElementById('confirmEditHistory').addEventListener('click', () => {
                const type = document.getElementById('editHistoryType').value;
                const amount = document.getElementById('editHistoryAmount').value.trim();
                const description = document.getElementById('editHistoryDescription').value.trim();

                if (!amount || parseFloat(amount) <= 0) {
                    alert('请输入有效的金额！');
                    return;
                }

                if (type === 'subtract') {
                    const user = vipManager.getUser(currentUserId);
                    // 计算新余额（先减去旧的，再加上新的）
                    const record = vipManager.getHistory(currentUserId, currentHistoryId);
                    if (record) {
                        const oldEffect = record.type === 'add' ? -record.amount : record.amount;
                        const newEffect = type === 'add' ? parseFloat(amount) : -parseFloat(amount);
                        const newBalance = user.amount + oldEffect + newEffect;

                        if (newBalance < 0) {
                            alert('操作后余额不能为负数！');
                            return;
                        }
                    }
                }

                if (vipManager.editHistory(currentUserId, currentHistoryId, {
                    type: type,
                    amount: amount,
                    description: description
                })) {
                    editHistoryModal.classList.add('hidden');
                    renderUserList();
                    renderRecentUsers();

                    // 更新详情页
                    if (!userDetailModal.classList.contains('hidden')) {
                        openUserDetail(currentUserId);
                    }

                    alert('历史记录修改成功！');
                } else {
                    alert('操作失败，请重试！');
                }
            });

            // 确认删除历史记录
            document.getElementById('confirmDeleteHistory').addEventListener('click', () => {
                if (vipManager.deleteHistory(currentUserId, currentHistoryId)) {
                    deleteHistoryModal.classList.add('hidden');
                    renderUserList();
                    renderRecentUsers();

                    // 更新详情页
                    if (!userDetailModal.classList.contains('hidden')) {
                        openUserDetail(currentUserId);
                    }

                    alert('历史记录删除成功！');
                } else {
                    alert('操作失败，请重试！');
                }
            });

            // 确认删除用户
            document.getElementById('confirmDeleteUser').addEventListener('click', () => {
                if (vipManager.deleteUser(currentUserId)) {
                    deleteUserModal.classList.add('hidden');
                    renderUserList();
                    renderRecentUsers();

                    // 如果删除的是当前打开的用户，关闭详情页
                    if (!userDetailModal.classList.contains('hidden')) {
                        userDetailModal.classList.add('hidden');
                    }

                    alert('用户删除成功！');
                } else {
                    alert('操作失败，请重试！');
                }
            });

            // 切换置顶状态
            document.getElementById('togglePinBtn').addEventListener('click', () => {
                if (currentUserId) {
                    toggleUserPin(currentUserId);
                }
            });

            // 添加金额按钮
            document.getElementById('addAmountBtn').addEventListener('click', () => {
                if (currentUserId) {
                    openAddAmountModal();
                }
            });

            // 减少金额按钮
            document.getElementById('subtractAmountBtn').addEventListener('click', () => {
                if (currentUserId) {
                    openSubtractAmountModal();
                }
            });

            // 筛选用户
            filterSelect.addEventListener('change', () => {
                activeFilter = filterSelect.value;
                currentPage = 1;
                renderUserList();
            });

            // 全局搜索
            globalSearch.addEventListener('input', () => {
                searchQuery = globalSearch.value.trim();
                currentPage = 1;
                renderUserList();
            });

            // 分页控制
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderUserList();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderUserList();
                }
            });

            // 刷新按钮
            document.getElementById('refreshBtn').addEventListener('click', async () => {
                await vipManager.loadData();
                renderUserList();
                renderRecentUsers();
            });

            // 设置按钮事件
            document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);

            // 常用功能区系统设置链接事件
            document.getElementById('settingsLink').addEventListener('click', function (e) {
                e.preventDefault();
                openSettingsModal();
            });

            // 移动端底部导航：复用侧边栏的功能
            const mobileUsersLink = document.getElementById('mobileUsersLink');
            if (mobileUsersLink) {
                mobileUsersLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('allUsersLink')?.click();
                });
            }

            const mobileStatsLink = document.getElementById('mobileStatsLink');
            if (mobileStatsLink) {
                mobileStatsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('statsLink')?.click();
                });
            }

            const mobileSettingsLink = document.getElementById('mobileSettingsLink');
            if (mobileSettingsLink) {
                mobileSettingsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('settingsLink')?.click();
                });
            }


            // 保存设置
            document.getElementById('saveSettings').addEventListener('click', () => {
                const newUsersPerPage = parseInt(document.getElementById('usersPerPage').value);
                usersPerPage = newUsersPerPage;
                localStorage.setItem('usersPerPage', newUsersPerPage);

                const currency = document.getElementById('currencySelect').value;
                localStorage.setItem('currency', currency);

                // 重新渲染用户列表
                currentPage = 1;
                renderUserList();

                // 关闭设置窗口
                settingsModal.classList.add('hidden');

                // ✅ 不再弹浏览器窗口
            });


            // 主题按钮事件
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const theme = this.getAttribute('data-theme');
                    localStorage.setItem('theme', theme);
                    applyTheme(theme);

                    // 更新按钮选中状态
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.classList.remove('ring-2', 'ring-primary');
                    });
                    this.classList.add('ring-2', 'ring-primary');
                });
            });

            // 常用功能区事件
            document.getElementById('pinnedUsersLink').addEventListener('click', (e) => {
                e.preventDefault();
                activeFilter = 'pinned';
                currentPage = 1;
                renderUserList();

                // 更新激活状态
                document.querySelectorAll('.common-function-link').forEach(link => {
                    link.classList.remove('bg-primary/5', 'text-primary');
                    link.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                });
                e.target.closest('.common-function-link').classList.add('bg-primary/5', 'text-primary');
                e.target.closest('.common-function-link').classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });

            // 所有用户
            document.getElementById('allUsersLink').addEventListener('click', (e) => {
                e.preventDefault();
                activeFilter = 'all';
                currentPage = 1;
                renderUserList();

                // 更新激活状态
                document.querySelectorAll('.common-function-link').forEach(link => {
                    link.classList.remove('bg-primary/5', 'text-primary');
                    link.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                });
                e.target.closest('.common-function-link').classList.add('bg-primary/5', 'text-primary');
                e.target.closest('.common-function-link').classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });

            // 统计按钮事件
            document.getElementById('statsLink').addEventListener('click', (e) => {
                e.preventDefault();
                openStatsModal();
            });

            // 回收站链接事件
            document.getElementById('trashLink').addEventListener('click', (e) => {
                e.preventDefault();
                renderTrashList();
                document.getElementById('trashModal').classList.remove('hidden');
            });


            // 清空回收站（不可恢复）
            const clearTrashBtn = document.getElementById('clearTrashBtn');
            if (clearTrashBtn) {
                clearTrashBtn.addEventListener('click', () => {
                    if (!vipManager.getTrashUsers || vipManager.getTrashUsers().length === 0) return;
                    const ok = confirm('确定要清空回收站吗？该操作不可恢复。');
                    if (!ok) return;
                    vipManager.clearTrash();
                    vipManager.addLog({
                        type: 'CLEAR_TRASH',
                        note: '清空回收站'
                    });
                    renderTrashList();
                });
            }


            // 更新图表按钮
            document.getElementById('updateChartBtn').addEventListener('click', () => {
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);

                if (startDate > endDate) {
                    alert('开始日期不能晚于结束日期！');
                    return;
                }

                drawConsumptionChart(startDate, endDate);
            });

            // 日期选择体验优化：点击日期输入框任意位置，直接弹出日期选择器（支持的浏览器）
            ['startDate', 'endDate'].forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;

                const tryShow = () => {
                    // showPicker: Chrome/Edge 等支持；不支持时会被忽略
                    if (typeof el.showPicker === 'function') el.showPicker();
                };

                el.addEventListener('click', tryShow);
                el.addEventListener('focus', tryShow);
            });

            // 清空最近浏览记录
            document.getElementById('clearRecentBtn').addEventListener('click', function () {
                vipManager.recentViewed = [];
                vipManager.saveData();
                renderRecentUsers();
                // ✅ 清空最近浏览也要触发云端 meta 同步（vip_meta）
                window.scheduleAutoSync?.('clear_recent');
            });
        

            // 数据导入导出（设置页）
            const exportBtn = document.getElementById('exportDataBtn');
            const importBtn = document.getElementById('importDataBtn');
            const importInput = document.getElementById('importFileInput');

            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    try {
                        const payload = buildExportPayload();
                        const filename = `vip-manager-backup-${formatDateForFilename(new Date())}.json`;
                        downloadJSON(payload, filename);
                        setBackupStatus(`✅ 已导出：${filename}`);
                    } catch (e) {
                        setBackupStatus('❌ 导出失败：' + (e && e.message ? e.message : e), true);
                    }
                });
            }

            if (importBtn && importInput) {
                importBtn.addEventListener('click', () => {
                    importInput.click();
                });
//-----------------------------------------------------------

                document.getElementById('logsList').addEventListener('click', (e) => {
                    const btn = e.target.closest('.delete-log-btn');
                    if (!btn) return;

                    const idx = Number(btn.dataset.index);
                    if (!Number.isFinite(idx)) return;

                    const ok = confirm('确定要删除这条日志吗？');
                    if (!ok) return;

                    vipManager.logs.splice(idx, 1);
                    vipManager.saveData();
                    renderLogsList();
                    // ✅ 删除单条日志也要触发云端 meta 同步（vip_meta）
                    window.scheduleAutoSync?.('delete_log');
                });

                const logTypeFilter = document.getElementById('logTypeFilter');
                if (logTypeFilter) {
                    logTypeFilter.addEventListener('change', renderLogsList);
                }

                // 打开日志页
                document.getElementById('logsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    renderLogsList();
                    document.getElementById('logsModal').classList.remove('hidden');
                });

                // 关闭日志页（右上角 X）
                document.getElementById('closeLogsModal').addEventListener('click', () => {
                    document.getElementById('logsModal').classList.add('hidden');
                });

                // 关闭日志页（底部按钮）
                document.getElementById('closeLogsBtn').addEventListener('click', () => {
                    document.getElementById('logsModal').classList.add('hidden');
                });

                // 清空日志
                document.getElementById('clearLogsBtn').addEventListener('click', () => {
                    const ok = confirm('确定要清空所有日志吗？此操作不可撤销。');
                    if (!ok) return;

                    vipManager.clearLogs();
                    renderLogsList();
                });

                importInput.addEventListener('change', async () => {
                    const file = importInput.files && importInput.files[0];
                    if (!file) return;

                    try {
                        const mode = (document.getElementById('importMode') || {}).value || 'overwrite';
                        const autoBackup = (document.getElementById('autoBackupBeforeImport') || {}).checked;

                        // 覆盖导入前先备份一份（可选）
                        if (mode === 'overwrite' && autoBackup) {
                            const backup = buildExportPayload();
                            const backupName = `vip-manager-backup-before-import-${formatDateForFilename(new Date())}.json`;
                            downloadJSON(backup, backupName);
                        }

                        const text = await file.text();
                        const raw = JSON.parse(text);
                        const normalized = normalizeImportPayload(raw);
                        if (!normalized) {
                            throw new Error('文件格式不兼容（不是本系统导出的JSON）。');
                        }

                        const result = applyImport(normalized, mode);

                        // 刷新UI
                        currentUserId = null;
                        currentHistoryId = null;
                        currentPage = 1;
                        userDetailModal.classList.add('hidden');
                        renderUserList();
                        renderRecentUsers();

                        setBackupStatus(`✅ 导入成功：新增 ${result.added}，覆盖 ${result.overwritten}，跳过 ${result.skipped}`);
                    } catch (e) {
                        setBackupStatus('❌ 导入失败：' + (e && e.message ? e.message : e), true);
                    } finally {
                        importInput.value = '';
                    }
                });

                // ===== 回收站：打开/关闭 =====
                const trashModal = document.getElementById('trashModal');
                const trashLink = document.getElementById('trashLink');
                const closeTrashModal = document.getElementById('closeTrashModal');
                const closeTrashBtn = document.getElementById('closeTrashBtn');
                const clearTrashBtn2 = document.getElementById('clearTrashBtn');

                if (trashLink) {
                    trashLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        renderTrashList();
                        trashModal.classList.remove('hidden');
                    });
                }

                if (closeTrashModal) {
                    closeTrashModal.addEventListener('click', () => {
                        trashModal.classList.add('hidden');
                    });
                }

                if (closeTrashBtn) {
                    closeTrashBtn.addEventListener('click', () => {
                        trashModal.classList.add('hidden');
                    });
                }

                if (clearTrashBtn2) {
                    clearTrashBtn2.addEventListener('click', () => {
                        if (!vipManager.getTrashUsers || vipManager.getTrashUsers().length === 0) return;
                        const ok = confirm('确定要清空回收站吗？该操作不可恢复。');
                        if (!ok) return;
                        vipManager.clearTrash();
                        renderTrashList();
                    });
                }
            }
});
    </script>
</body>

</html>
